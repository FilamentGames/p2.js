/**
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 p2.js authors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&false)define(e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.p2=e()}}(function(){return function e(f,n,o){function d(t,l){if(!n[t]){if(!f[t]){var p="function"==typeof require&&require;if(!l&&p)return p(t,!0);if(i)return i(t,!0);throw new Error("Cannot find module '"+t+"'")}var u=n[t]={exports:{}};f[t][0].call(u.exports,function(e){var n=f[t][1][e];return d(n?n:e)},u,u.exports,e,f,n,o)}return n[t].exports}for(var i="function"==typeof require&&require,t=0;t<o.length;t++)d(o[t]);return d}({1:[function(e,f,n){function o(){}var d=e("./Scalar");f.exports=o,o.lineInt=function(e,f,n){n=n||0;var o,i,t,l,p,u,s,c=[0,0];return o=e[1][1]-e[0][1],i=e[0][0]-e[1][0],t=o*e[0][0]+i*e[0][1],l=f[1][1]-f[0][1],p=f[0][0]-f[1][0],u=l*f[0][0]+p*f[0][1],s=o*p-l*i,d.eq(s,0,n)||(c[0]=(p*t-i*u)/s,c[1]=(o*u-l*t)/s),c},o.segmentsIntersect=function(e,f,n,o){var d=f[0]-e[0],i=f[1]-e[1],t=o[0]-n[0],l=o[1]-n[1];if(t*i-l*d==0)return!1;var p=(d*(n[1]-e[1])+i*(e[0]-n[0]))/(t*i-l*d),u=(t*(e[1]-n[1])+l*(n[0]-e[0]))/(l*d-t*i);return p>=0&&1>=p&&u>=0&&1>=u}},{"./Scalar":4}],2:[function(e,f,n){function o(){}f.exports=o,o.area=function(e,f,n){return(f[0]-e[0])*(n[1]-e[1])-(n[0]-e[0])*(f[1]-e[1])},o.left=function(e,f,n){return o.area(e,f,n)>0},o.leftOn=function(e,f,n){return o.area(e,f,n)>=0},o.right=function(e,f,n){return o.area(e,f,n)<0},o.rightOn=function(e,f,n){return o.area(e,f,n)<=0};var d=[],i=[];o.collinear=function(e,f,n,t){if(t){var l=d,p=i;l[0]=f[0]-e[0],l[1]=f[1]-e[1],p[0]=n[0]-f[0],p[1]=n[1]-f[1];var u=l[0]*p[0]+l[1]*p[1],s=Math.sqrt(l[0]*l[0]+l[1]*l[1]),c=Math.sqrt(p[0]*p[0]+p[1]*p[1]),y=Math.acos(u/(s*c));return t>y}return 0==o.area(e,f,n)},o.sqdist=function(e,f){var n=f[0]-e[0],o=f[1]-e[1];return n*n+o*o}},{}],3:[function(e,f,n){function o(){this.vertices=[]}function d(e,f,n,o,d){d=d||0;var i=f[1]-e[1],t=e[0]-f[0],p=i*e[0]+t*e[1],u=o[1]-n[1],s=n[0]-o[0],c=u*n[0]+s*n[1],y=i*s-u*t;return l.eq(y,0,d)?[0,0]:[(s*p-t*c)/y,(i*c-u*p)/y]}var i=e("./Line"),t=e("./Point"),l=e("./Scalar");f.exports=o,o.prototype.at=function(e){var f=this.vertices,n=f.length;return f[0>e?e%n+n:e%n]},o.prototype.first=function(){return this.vertices[0]},o.prototype.last=function(){return this.vertices[this.vertices.length-1]},o.prototype.clear=function(){this.vertices.length=0},o.prototype.append=function(e,f,n){if("undefined"==typeof f)throw new Error("From is not given!");if("undefined"==typeof n)throw new Error("To is not given!");if(f>n-1)throw new Error("lol1");if(n>e.vertices.length)throw new Error("lol2");if(0>f)throw new Error("lol3");for(var o=f;n>o;o++)this.vertices.push(e.vertices[o])},o.prototype.makeCCW=function(){for(var e=0,f=this.vertices,n=1;n<this.vertices.length;++n)(f[n][1]<f[e][1]||f[n][1]==f[e][1]&&f[n][0]>f[e][0])&&(e=n);t.left(this.at(e-1),this.at(e),this.at(e+1))||this.reverse()},o.prototype.reverse=function(){for(var e=[],f=0,n=this.vertices.length;f!==n;f++)e.push(this.vertices.pop());this.vertices=e},o.prototype.isReflex=function(e){return t.right(this.at(e-1),this.at(e),this.at(e+1))};var p=[],u=[];o.prototype.canSee=function(e,f){var n,o,d=p,l=u;if(t.leftOn(this.at(e+1),this.at(e),this.at(f))&&t.rightOn(this.at(e-1),this.at(e),this.at(f)))return!1;o=t.sqdist(this.at(e),this.at(f));for(var s=0;s!==this.vertices.length;++s)if((s+1)%this.vertices.length!==e&&s!==e&&t.leftOn(this.at(e),this.at(f),this.at(s+1))&&t.rightOn(this.at(e),this.at(f),this.at(s))&&(d[0]=this.at(e),d[1]=this.at(f),l[0]=this.at(s),l[1]=this.at(s+1),n=i.lineInt(d,l),t.sqdist(this.at(e),n)<o))return!1;return!0},o.prototype.copy=function(e,f,n){var d=n||new o;if(d.clear(),f>e)for(var i=e;f>=i;i++)d.vertices.push(this.vertices[i]);else{for(var i=0;f>=i;i++)d.vertices.push(this.vertices[i]);for(var i=e;i<this.vertices.length;i++)d.vertices.push(this.vertices[i])}return d},o.prototype.getCutEdges=function(){for(var e=[],f=[],n=[],d=new o,i=Number.MAX_VALUE,t=0;t<this.vertices.length;++t)if(this.isReflex(t))for(var l=0;l<this.vertices.length;++l)if(this.canSee(t,l)){f=this.copy(t,l,d).getCutEdges(),n=this.copy(l,t,d).getCutEdges();for(var p=0;p<n.length;p++)f.push(n[p]);f.length<i&&(e=f,i=f.length,e.push([this.at(t),this.at(l)]))}return e},o.prototype.decomp=function(){var e=this.getCutEdges();return e.length>0?this.slice(e):[this]},o.prototype.slice=function(e){if(0==e.length)return[this];if(e instanceof Array&&e.length&&e[0]instanceof Array&&2==e[0].length&&e[0][0]instanceof Array){for(var f=[this],n=0;n<e.length;n++)for(var o=e[n],d=0;d<f.length;d++){var i=f[d],t=i.slice(o);if(t){f.splice(d,1),f.push(t[0],t[1]);break}}return f}var o=e,n=this.vertices.indexOf(o[0]),d=this.vertices.indexOf(o[1]);return-1!=n&&-1!=d?[this.copy(n,d),this.copy(d,n)]:!1},o.prototype.isSimple=function(){for(var e=this.vertices,f=0;f<e.length-1;f++)for(var n=0;f-1>n;n++)if(i.segmentsIntersect(e[f],e[f+1],e[n],e[n+1]))return!1;for(var f=1;f<e.length-2;f++)if(i.segmentsIntersect(e[0],e[e.length-1],e[f],e[f+1]))return!1;return!0},o.prototype.quickDecomp=function(e,f,n,i,l,p){l=l||100,p=p||0,i=i||25,e="undefined"!=typeof e?e:[],f=f||[],n=n||[];var u=[0,0],s=[0,0],c=[0,0],y=0,a=0,r=0,w=0,b=0,g=0,m=0,x=new o,j=new o,v=this,h=this.vertices;if(h.length<3)return e;if(p++,p>l)return console.warn("quickDecomp: max level ("+l+") reached."),e;for(var k=0;k<this.vertices.length;++k)if(v.isReflex(k)){f.push(v.vertices[k]),y=a=Number.MAX_VALUE;for(var q=0;q<this.vertices.length;++q)t.left(v.at(k-1),v.at(k),v.at(q))&&t.rightOn(v.at(k-1),v.at(k),v.at(q-1))&&(c=d(v.at(k-1),v.at(k),v.at(q),v.at(q-1)),t.right(v.at(k+1),v.at(k),c)&&(r=t.sqdist(v.vertices[k],c),a>r&&(a=r,s=c,g=q))),t.left(v.at(k+1),v.at(k),v.at(q+1))&&t.rightOn(v.at(k+1),v.at(k),v.at(q))&&(c=d(v.at(k+1),v.at(k),v.at(q),v.at(q+1)),t.left(v.at(k-1),v.at(k),c)&&(r=t.sqdist(v.vertices[k],c),y>r&&(y=r,u=c,b=q)));if(g==(b+1)%this.vertices.length)c[0]=(s[0]+u[0])/2,c[1]=(s[1]+u[1])/2,n.push(c),b>k?(x.append(v,k,b+1),x.vertices.push(c),j.vertices.push(c),0!=g&&j.append(v,g,v.vertices.length),j.append(v,0,k+1)):(0!=k&&x.append(v,k,v.vertices.length),x.append(v,0,b+1),x.vertices.push(c),j.vertices.push(c),j.append(v,g,k+1));else{if(g>b&&(b+=this.vertices.length),w=Number.MAX_VALUE,g>b)return e;for(var q=g;b>=q;++q)t.leftOn(v.at(k-1),v.at(k),v.at(q))&&t.rightOn(v.at(k+1),v.at(k),v.at(q))&&(r=t.sqdist(v.at(k),v.at(q)),w>r&&(w=r,m=q%this.vertices.length));m>k?(x.append(v,k,m+1),0!=m&&j.append(v,m,h.length),j.append(v,0,k+1)):(0!=k&&x.append(v,k,h.length),x.append(v,0,m+1),j.append(v,m,k+1))}return x.vertices.length<j.vertices.length?(x.quickDecomp(e,f,n,i,l,p),j.quickDecomp(e,f,n,i,l,p)):(j.quickDecomp(e,f,n,i,l,p),x.quickDecomp(e,f,n,i,l,p)),e}return e.push(this),e},o.prototype.removeCollinearPoints=function(e){for(var f=0,n=this.vertices.length-1;this.vertices.length>3&&n>=0;--n)t.collinear(this.at(n-1),this.at(n),this.at(n+1),e)&&(this.vertices.splice(n%this.vertices.length,1),n--,f++);return f}},{"./Line":1,"./Point":2,"./Scalar":4}],4:[function(e,f,n){function o(){}f.exports=o,o.eq=function(e,f,n){return n=n||0,Math.abs(e-f)<n}},{}],5:[function(e,f,n){f.exports={Polygon:e("./Polygon"),Point:e("./Point")}},{"./Point":2,"./Polygon":3}],6:[function(e,f,n){function o(e){e=e||{},this.lowerBound=e.lowerBound?d.clone(e.lowerBound):d.create(),this.upperBound=e.upperBound?d.clone(e.upperBound):d.create()}var d=e("../math/vec2");f.exports=o;var i=d.create();o.prototype.setFromPoints=function(e,f,n,o){var t=this.lowerBound,l=this.upperBound;n=n||0,0!==n?d.rotate(t,e[0],n):d.copy(t,e[0]),d.copy(l,t);for(var p=Math.cos(n),u=Math.sin(n),s=1;s<e.length;s++){var c=e[s];if(0!==n){var y=c[0],a=c[1];i[0]=p*y-u*a,i[1]=u*y+p*a,c=i}for(var r=0;2>r;r++)c[r]>l[r]&&(l[r]=c[r]),c[r]<t[r]&&(t[r]=c[r])}f&&(d.add(t,t,f),d.add(l,l,f)),o&&(t[0]-=o,t[1]-=o,l[0]+=o,l[1]+=o)},o.prototype.copy=function(e){d.copy(this.lowerBound,e.lowerBound),d.copy(this.upperBound,e.upperBound)},o.prototype.extend=function(e){for(var f=this.lowerBound,n=this.upperBound,o=2;o--;){var d=e.lowerBound[o];f[o]>d&&(f[o]=d);var i=e.upperBound[o];n[o]<i&&(n[o]=i)}},o.prototype.overlaps=function(e){var f=this.lowerBound,n=this.upperBound,o=e.lowerBound,d=e.upperBound;return(o[0]<=n[0]&&n[0]<=d[0]||f[0]<=d[0]&&d[0]<=n[0])&&(o[1]<=n[1]&&n[1]<=d[1]||f[1]<=d[1]&&d[1]<=n[1])},o.prototype.containsPoint=function(e){var f=this.lowerBound,n=this.upperBound;return f[0]<=e[0]&&e[0]<=n[0]&&f[1]<=e[1]&&e[1]<=n[1]},o.prototype.overlapsRay=function(e){var f=1/e.direction[0],n=1/e.direction[1],o=e.from,d=this.lowerBound,i=this.upperBound,t=(d[0]-o[0])*f,l=(i[0]-o[0])*f,p=(d[1]-o[1])*n,u=(i[1]-o[1])*n,s=Math.max(Math.max(Math.min(t,l),Math.min(p,u))),c=Math.min(Math.min(Math.max(t,l),Math.max(p,u)));return 0>c?-1:s>c?-1:s}},{"../math/vec2":29}],7:[function(e,f,n){function o(e){this.type=e,this.result=[],this.world=null,this.boundingVolumeType=o.AABB}var d=e("../math/vec2"),i=e("../objects/Body");f.exports=o,o.AABB=1,o.BOUNDING_CIRCLE=2,o.prototype.setWorld=function(e){this.world=e},o.prototype.getCollisionPairs=function(){},o.boundingRadiusCheck=function(e,f){var n=d.squaredDistance(e.position,f.position),o=e.boundingRadius+f.boundingRadius;return o*o>=n},o.aabbCheck=function(e,f){return e.getAABB().overlaps(f.getAABB())},o.prototype.boundingVolumeCheck=function(e,f){var n;switch(this.boundingVolumeType){case o.BOUNDING_CIRCLE:n=o.boundingRadiusCheck(e,f);break;case o.AABB:n=o.aabbCheck(e,f);break;default:throw new Error("Bounding volume type not recognized: "+this.boundingVolumeType)}return n},o.canCollide=function(e,f){var n=i.KINEMATIC,o=i.STATIC,d=e.type,t=f.type;return d===o&&t===o?!1:d===n&&t===o||d===o&&t===n?!1:d===n&&t===n?!1:e.sleepState===i.SLEEPING&&f.sleepState===i.SLEEPING?!1:e.sleepState===i.SLEEPING&&t===o||f.sleepState===i.SLEEPING&&d===o?!1:!0},o.NAIVE=1,o.SAP=2,o.prototype.aabbQuery=function(){}},{"../math/vec2":29,"../objects/Body":30}],8:[function(e,f,n){function o(){d.call(this,d.NAIVE)}var d=e("../collision/Broadphase");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.getCollisionPairs=function(e){var f=e.bodies,n=this.result;n.length=0;for(var o=0,i=f.length;o!==i;o++)for(var t=f[o],l=0;o>l;l++){var p=f[l];d.canCollide(t,p)&&this.boundingVolumeCheck(t,p)&&n.push(t,p)}return n},o.prototype.aabbQuery=function(e,f,n){n=n||[];for(var o=e.bodies,d=0;d<o.length;d++){var i=o[d];i.aabbNeedsUpdate&&i.updateAABB(),i.aabb.overlaps(f)&&n.push(i)}return n}},{"../collision/Broadphase":7}],9:[function(e,f,n){function o(){this.contactEquations=[],this.frictionEquations=[],this.enableFriction=!0,this.enabledEquations=!0,this.slipForce=10,this.contactEquationPool=new m({size:32}),this.frictionEquationPool=new x({size:64}),this.enableFrictionReduction=!0,this.collidingBodiesLastStep=new j,this.currentContactMaterial=null}function d(e,f){var n=f.radius,o=.5*f.length,d=e.vertices;p.set(d[0],-o,-n),p.set(d[1],o,-n),p.set(d[2],o,n),p.set(d[3],-o,n)}function i(e,f,n,o){var d=X,i=Y,t=Z,l=f.vertices,s=null;p.toLocalFrame(d,e,n,o);for(var c=0,y=l.length;c!==y+1;c++){var a=l[c%y],r=l[(c+1)%y];u(i,a,d),u(t,r,d);var w=p.crossLength(i,t);if(null===s&&(s=w),0>w*s)return!1;s=w}return!0}function t(e,f){for(var n=Y,o=Z,d=f.vertices,i=null,t=d.length,l=0;t+1>l;l++){var s=d[l%t],c=d[(l+1)%t];u(n,s,e),u(o,c,e);var y=p.crossLength(n,o);if(null===i&&(i=y),0>y*i)return!1;i=y}return!0}function l(e,f,n,o){e[0]=f[0]+n[0]-o[0],e[1]=f[1]+n[1]-o[1]}var p=e("../math/vec2"),u=p.sub,s=p.add,c=p.dot,y=p.rotate,a=p.normalize,r=p.copy,w=p.scale,b=p.squaredLength,g=p.create,m=e("../utils/ContactEquationPool"),x=e("../utils/FrictionEquationPool"),j=e("../utils/TupleDictionary"),v=e("../shapes/Circle"),h=e("../shapes/Convex"),k=e("../shapes/Shape"),q=e("../shapes/Box");f.exports=o;var z=p.fromValues(0,1),A=g(),B=g(),C=g(),D=g(),E=g(),F=g(),G=g(),H=g(),I=g(),J=g(),K=g(),L=g(),M=g(),N=g(),O=g(),P=[],Q=g(),R=g();o.prototype.bodiesOverlap=function(e,f,n){for(var o=Q,d=R,i=0,t=e.shapes.length;i!==t;i++)for(var l=e.shapes[i],p=0,u=f.shapes.length;p!==u;p++){var s=f.shapes[p];if(n&&(0===(l.collisionGroup&s.collisionMask)||0===(s.collisionGroup&l.collisionMask)))return;if(e.toWorldFrame(o,l.position),f.toWorldFrame(d,s.position),this[l.type|s.type](e,l,o,l.angle+e.angle,f,s,d,s.angle+f.angle,!0))return!0}return!1},o.prototype.collidedLastStep=function(e,f){var n=0|e.id,o=0|f.id;return!!this.collidingBodiesLastStep.get(n,o)},o.prototype.reset=function(){this.collidingBodiesLastStep.reset();for(var e=this.contactEquations,f=e.length;f--;){var n=e[f],o=n.bodyA.id,d=n.bodyB.id;this.collidingBodiesLastStep.set(o,d,!0)}for(var i=this.contactEquations,t=this.frictionEquations,l=0;l<i.length;l++)this.contactEquationPool.release(i[l]);for(var l=0;l<t.length;l++)this.frictionEquationPool.release(t[l]);this.contactEquations.length=this.frictionEquations.length=0},o.prototype.createContactEquation=function(e,f,n,o){var d=this.contactEquationPool.get(),i=this.currentContactMaterial;return d.bodyA=e,d.bodyB=f,d.shapeA=n,d.shapeB=o,d.enabled=this.enabledEquations,d.firstImpact=!this.collidedLastStep(e,f),d.restitution=i.restitution,d.stiffness=i.stiffness,d.relaxation=i.relaxation,d.offset=i.contactSkinSize,d.needsUpdate=!0,d},o.prototype.createFrictionEquation=function(e,f,n,o){var d=this.frictionEquationPool.get(),i=this.currentContactMaterial;return d.bodyA=e,d.bodyB=f,d.shapeA=n,d.shapeB=o,d.setSlipForce(this.slipForce),d.enabled=this.enabledEquations,d.frictionCoefficient=i.friction,d.relativeVelocity=i.surfaceVelocity,d.stiffness=i.frictionStiffness,d.relaxation=i.frictionRelaxation,d.needsUpdate=!0,d.contactEquations.length=0,d},o.prototype.createFrictionFromContact=function(e){var f=this.createFrictionEquation(e.bodyA,e.bodyB,e.shapeA,e.shapeB);return r(f.contactPointA,e.contactPointA),r(f.contactPointB,e.contactPointB),p.rotate90cw(f.t,e.normalA),f.contactEquations.push(e),f},o.prototype.createFrictionFromAverage=function(e){var f=this.contactEquations[this.contactEquations.length-1],n=this.createFrictionEquation(f.bodyA,f.bodyB,f.shapeA,f.shapeB),o=f.bodyA;p.set(n.contactPointA,0,0),p.set(n.contactPointB,0,0),p.set(n.t,0,0);for(var d=0;d!==e;d++)f=this.contactEquations[this.contactEquations.length-1-d],f.bodyA===o?(s(n.t,n.t,f.normalA),s(n.contactPointA,n.contactPointA,f.contactPointA),s(n.contactPointB,n.contactPointB,f.contactPointB)):(u(n.t,n.t,f.normalA),s(n.contactPointA,n.contactPointA,f.contactPointB),s(n.contactPointB,n.contactPointB,f.contactPointA)),n.contactEquations.push(f);var i=1/e;return w(n.contactPointA,n.contactPointA,i),w(n.contactPointB,n.contactPointB,i),a(n.t,n.t),p.rotate90cw(n.t,n.t),n},o.prototype[k.LINE|k.CONVEX]=o.prototype.convexLine=function(e,f,n,o,d,i,t,l,p){return p?!1:0},o.prototype[k.LINE|k.BOX]=o.prototype.lineBox=function(e,f,n,o,d,i,t,l,p){return p?!1:0};var S=new q({width:1,height:1}),T=g();o.prototype[k.CAPSULE|k.CONVEX]=o.prototype[k.CAPSULE|k.BOX]=o.prototype.convexCapsule=function(e,f,n,o,i,t,l,u,s){var c=T,y=t.length/2;p.set(c,y,0),p.toGlobalFrame(c,c,l,u);var a=this.circleConvex(i,t,c,u,e,f,n,o,s,t.radius);p.set(c,-y,0),p.toGlobalFrame(c,c,l,u);var r=this.circleConvex(i,t,c,u,e,f,n,o,s,t.radius);if(s&&(a||r))return!0;var w=S;d(w,t);var b=this.convexConvex(e,f,n,o,i,w,l,u,s);return b+a+r},o.prototype[k.CAPSULE|k.LINE]=o.prototype.lineCapsule=function(e,f,n,o,d,i,t,l,p){return p?!1:0};var U=g(),V=g(),W=new q({width:1,height:1});o.prototype[k.CAPSULE|k.CAPSULE]=o.prototype.capsuleCapsule=function(e,f,n,o,i,t,l,u,s){for(var c,y=U,a=V,r=0,w=0;2>w;w++){p.set(y,(0===w?-1:1)*f.length/2,0),p.toGlobalFrame(y,y,n,o);for(var b=0;2>b;b++){p.set(a,(0===b?-1:1)*t.length/2,0),p.toGlobalFrame(a,a,l,u),this.enableFrictionReduction&&(c=this.enableFriction,this.enableFriction=!1);var g=this.circleCircle(e,f,y,o,i,t,a,u,s,f.radius,t.radius);if(this.enableFrictionReduction&&(this.enableFriction=c),s&&g)return!0;r+=g}}this.enableFrictionReduction&&(c=this.enableFriction,this.enableFriction=!1);var m=W;d(m,f);var x=this.convexCapsule(e,m,n,o,i,t,l,u,s);if(this.enableFrictionReduction&&(this.enableFriction=c),s&&x)return!0;if(r+=x,this.enableFrictionReduction){var c=this.enableFriction;this.enableFriction=!1}d(m,t);var j=this.convexCapsule(i,m,l,u,e,f,n,o,s);return this.enableFrictionReduction&&(this.enableFriction=c),s&&j?!0:(r+=j,this.enableFrictionReduction&&r&&this.enableFriction&&this.frictionEquations.push(this.createFrictionFromAverage(r)),r)},o.prototype[k.LINE|k.LINE]=o.prototype.lineLine=function(e,f,n,o,d,i,t,l,p){return p?!1:0},o.prototype[k.PLANE|k.LINE]=o.prototype.planeLine=function(e,f,n,o,d,i,t,l,b){var g=A,m=B,x=C,j=D,v=E,h=F,k=G,q=H,J=I,K=P,L=0;p.set(g,-i.length/2,0),p.set(m,i.length/2,0),p.toGlobalFrame(x,g,t,l),p.toGlobalFrame(j,m,t,l),r(g,x),r(m,j),u(v,m,g),a(h,v),p.rotate90cw(J,h),y(q,z,o),K[0]=g,K[1]=m;for(var M=0;M<K.length;M++){var N=K[M];u(k,N,n);var O=c(k,q);if(0>O){if(b)return!0;var Q=this.createContactEquation(e,d,f,i);L++,r(Q.normalA,q),a(Q.normalA,Q.normalA),w(k,q,O),u(Q.contactPointA,N,k),u(Q.contactPointA,Q.contactPointA,e.position),u(Q.contactPointB,N,t),s(Q.contactPointB,Q.contactPointB,t),u(Q.contactPointB,Q.contactPointB,d.position),this.contactEquations.push(Q),this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(Q))}}return b?!1:(this.enableFrictionReduction||L&&this.enableFriction&&this.frictionEquations.push(this.createFrictionFromAverage(L)),L)},o.prototype[k.PARTICLE|k.CAPSULE]=o.prototype.particleCapsule=function(e,f,n,o,d,i,t,l,p){return this.circleLine(e,f,n,o,d,i,t,l,p,i.radius,0)},o.prototype[k.CIRCLE|k.LINE]=o.prototype.circleLine=function(e,f,n,o,d,i,t,l,y,g,m){var g=g||0,m=void 0!==m?m:f.radius,x=A,j=B,v=C,h=D,k=E,q=F,z=G,O=H,Q=I,R=J,S=K,T=L,U=M,V=N,W=P,X=i.length/2;p.set(O,-X,0),p.set(Q,X,0),p.toGlobalFrame(R,O,t,l),p.toGlobalFrame(S,Q,t,l),r(O,R),r(Q,S),u(q,Q,O),a(z,q),p.rotate90cw(k,z),u(T,n,O);var Y=c(T,k);u(h,O,t),u(U,n,t);var Z=m+g;if(Math.abs(Y)<Z){w(x,k,Y),u(v,n,x),w(j,k,c(k,U)),a(j,j),w(j,j,g),s(v,v,j);var $=c(z,v),_=c(z,O),ee=c(z,Q);if($>_&&ee>$){if(y)return!0;var fe=this.createContactEquation(e,d,f,i);return w(fe.normalA,x,-1),a(fe.normalA,fe.normalA),w(fe.contactPointA,fe.normalA,m),s(fe.contactPointA,fe.contactPointA,n),u(fe.contactPointA,fe.contactPointA,e.position),u(fe.contactPointB,v,t),s(fe.contactPointB,fe.contactPointB,t),u(fe.contactPointB,fe.contactPointB,d.position),this.contactEquations.push(fe),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(fe)),1}}W[0]=O,W[1]=Q;for(var ne=0;ne<W.length;ne++){var oe=W[ne];if(u(T,oe,n),b(T)<Math.pow(Z,2)){if(y)return!0;var fe=this.createContactEquation(e,d,f,i);return r(fe.normalA,T),a(fe.normalA,fe.normalA),w(fe.contactPointA,fe.normalA,m),s(fe.contactPointA,fe.contactPointA,n),u(fe.contactPointA,fe.contactPointA,e.position),u(fe.contactPointB,oe,t),w(V,fe.normalA,-g),s(fe.contactPointB,fe.contactPointB,V),s(fe.contactPointB,fe.contactPointB,t),u(fe.contactPointB,fe.contactPointB,d.position),this.contactEquations.push(fe),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(fe)),1}}return 0},o.prototype[k.CIRCLE|k.CAPSULE]=o.prototype.circleCapsule=function(e,f,n,o,d,i,t,l,p){return this.circleLine(e,f,n,o,d,i,t,l,p,i.radius)},o.prototype[k.CIRCLE|k.CONVEX]=o.prototype[k.CIRCLE|k.BOX]=o.prototype.circleConvex=function(e,f,n,o,d,i,l,y,g,m){var m=void 0!==m?m:f.radius,x=A,j=B,v=C,h=D,k=E,q=F,z=G,I=H,L=J,P=K,Q=M,R=N,S=O,T=-1,U=Number.MAX_VALUE;p.set(q,0,0),p.toLocalFrame(z,n,l,y);for(var V=i.vertices,W=i.normals,X=V.length,Y=-1,Z=-Number.MAX_VALUE,$=i.boundingRadius+m,_=0;X>_;_++){u(I,z,V[_]);var ee=c(W[_],I);if(ee>$)return g?!1:0;ee>Z&&(Z=ee,Y=_)}for(var _=Y+X-1;Y+X+2>_;_++){var fe=V[_%X],ne=W[_%X];if(w(R,ne,-m),s(R,R,z),t(R,i)){u(S,fe,R);var oe=Math.abs(c(S,ne));U>oe&&(U=oe,T=_)}}if(-1!==T){if(g)return!0;var fe=V[T%X],de=V[(T+1)%X];p.toGlobalFrame(x,fe,l,y),p.toGlobalFrame(j,de,l,y),u(v,j,x),a(h,v),p.rotate90cw(k,h),w(R,k,-m),s(R,R,n),w(Q,k,U),s(Q,Q,R);var ie=this.createContactEquation(e,d,f,i);return u(ie.normalA,R,n),a(ie.normalA,ie.normalA),w(ie.contactPointA,ie.normalA,m),s(ie.contactPointA,ie.contactPointA,n),u(ie.contactPointA,ie.contactPointA,e.position),u(ie.contactPointB,Q,l),s(ie.contactPointB,ie.contactPointB,l),u(ie.contactPointB,ie.contactPointB,d.position),this.contactEquations.push(ie),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(ie)),1}if(m>0&&-1!==Y)for(var _=Y+X;Y+X+2>_;_++){var te=V[_%X];if(u(L,te,z),b(L)<m*m){if(g)return!0;p.toGlobalFrame(P,te,l,y),u(L,P,n);var ie=this.createContactEquation(e,d,f,i);return r(ie.normalA,L),a(ie.normalA,ie.normalA),w(ie.contactPointA,ie.normalA,m),s(ie.contactPointA,ie.contactPointA,n),u(ie.contactPointA,ie.contactPointA,e.position),u(ie.contactPointB,P,l),s(ie.contactPointB,ie.contactPointB,l),u(ie.contactPointB,ie.contactPointB,d.position),this.contactEquations.push(ie),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(ie)),1}}return 0};var X=g(),Y=g(),Z=g();o.prototype[k.PARTICLE|k.CONVEX]=o.prototype[k.PARTICLE|k.BOX]=o.prototype.particleConvex=function(e,f,n,o,d,t,l,b,g){var m=A,x=B,j=C,v=D,h=E,k=F,q=G,z=M,H=N,I=O,J=Number.MAX_VALUE,K=!1,L=t.vertices;if(!i(n,t,l,b))return g?!1:0;if(g)return!0;for(var P=0,Q=L.length;P!==Q+1;P++){var R=L[P%Q],S=L[(P+1)%Q];y(m,R,b),y(x,S,b),s(m,m,l),s(x,x,l),u(j,x,m),a(v,j),p.rotate90cw(h,v),u(k,m,l),u(q,n,l),u(H,m,n);var T=Math.abs(c(H,h));J>T&&(J=T,w(z,h,T),s(z,z,n),r(I,h),K=!0)}if(K){var U=this.createContactEquation(e,d,f,t);return w(U.normalA,I,-1),a(U.normalA,U.normalA),p.set(U.contactPointA,0,0),s(U.contactPointA,U.contactPointA,n),u(U.contactPointA,U.contactPointA,e.position),u(U.contactPointB,z,l),s(U.contactPointB,U.contactPointB,l),u(U.contactPointB,U.contactPointB,d.position),this.contactEquations.push(U),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(U)),1}return 0},o.prototype[k.CIRCLE]=o.prototype.circleCircle=function(e,f,n,o,d,i,t,p,s,c,y){var r=A,c=c||f.radius,y=y||i.radius;u(r,n,t);var g=c+y;if(b(r)>g*g)return 0;if(s)return!0;var m=this.createContactEquation(e,d,f,i),x=m.contactPointA,j=m.contactPointB,v=m.normalA;return u(v,t,n),a(v,v),w(x,v,c),w(j,v,-y),l(x,x,n,e.position),l(j,j,t,d.position),this.contactEquations.push(m),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(m)),1},o.prototype[k.PLANE|k.CONVEX]=o.prototype[k.PLANE|k.BOX]=o.prototype.planeConvex=function(e,f,n,o,d,i,t,l,s){var a=A,b=B,g=C,m=D,x=E,j=F,v=0;y(b,z,o),p.vectorToLocalFrame(x,b,l),p.toLocalFrame(m,n,t,l);for(var h=i.vertices,k=0,q=h.length;k!==q;k++){var G=h[k];if(u(j,G,m),c(j,x)<=0){if(s)return!0;p.toGlobalFrame(a,G,t,l),u(g,a,n),v++;var H=this.createContactEquation(e,d,f,i);u(g,a,n),r(H.normalA,b);var I=c(g,H.normalA);w(g,H.normalA,I),u(H.contactPointB,a,d.position),u(H.contactPointA,a,g),u(H.contactPointA,H.contactPointA,e.position),this.contactEquations.push(H),this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(H))}}return this.enableFrictionReduction&&this.enableFriction&&v&&this.frictionEquations.push(this.createFrictionFromAverage(v)),v},o.prototype[k.PARTICLE|k.PLANE]=o.prototype.particlePlane=function(e,f,n,o,d,i,t,l,p){var s=A,a=B;l=l||0,u(s,n,t),y(a,z,l);var b=c(s,a);if(b>0)return 0;if(p)return!0;var g=this.createContactEquation(d,e,i,f);return r(g.normalA,a),w(s,g.normalA,b),u(g.contactPointA,n,s),u(g.contactPointA,g.contactPointA,d.position),u(g.contactPointB,n,e.position),this.contactEquations.push(g),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(g)),1},o.prototype[k.CIRCLE|k.PARTICLE]=o.prototype.circleParticle=function(e,f,n,o,d,i,t,l,p){var c=A,y=f.radius;if(u(c,t,n),b(c)>y*y)return p?!1:0;if(p)return!0;var g=this.createContactEquation(e,d,f,i),m=g.normalA,x=g.contactPointA,j=g.contactPointB;return r(m,c),a(m,m),w(x,m,y),s(x,x,n),u(x,x,e.position),u(j,t,d.position),this.contactEquations.push(g),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(g)),1};var $=new v({radius:1}),_=g(),ee=g();o.prototype[k.PLANE|k.CAPSULE]=o.prototype.planeCapsule=function(e,f,n,o,d,i,t,l,u){var s=_,c=ee,y=$,a=i.length/2;p.set(s,-a,0),p.set(c,a,0),p.toGlobalFrame(s,s,t,l),p.toGlobalFrame(c,c,t,l),y.radius=i.radius;var r;this.enableFrictionReduction&&(r=this.enableFriction,this.enableFriction=!1);var w=this.circlePlane(d,y,s,0,e,f,n,o,u),b=this.circlePlane(d,y,c,0,e,f,n,o,u);if(this.enableFrictionReduction&&(this.enableFriction=r),u)return w||b;var g=w+b;return this.enableFrictionReduction&&g&&this.frictionEquations.push(this.createFrictionFromAverage(g)),g},o.prototype[k.CIRCLE|k.PLANE]=o.prototype.circlePlane=function(e,f,n,o,d,i,t,l,p){var a=f.radius,b=A,g=B,m=C;u(b,n,t),y(g,z,l);var x=c(g,b);if(x>a)return 0;if(p)return!0;var j=this.createContactEquation(d,e,i,f);r(j.normalA,g);var v=j.contactPointB;w(v,j.normalA,-a),s(v,v,n),u(v,v,e.position);var h=j.contactPointA;return w(m,j.normalA,x),u(h,b,m),s(h,h,t),u(h,h,d.position),this.contactEquations.push(j),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(j)),1},o.prototype[k.CONVEX]=o.prototype[k.CONVEX|k.BOX]=o.prototype[k.BOX]=o.prototype.convexConvex=function(e,f,n,d,i,t,l,r,b,g){var m=A,x=B,j=C,v=D,h=E,k=G,q=H,z=I,F=0,g=g||0,J=o.findSeparatingAxis(f,n,d,t,l,r,m);if(!J)return 0;u(q,l,n),c(m,q)>0&&w(m,m,-1);var K=o.getClosestEdge(f,d,m,!0),L=o.getClosestEdge(t,r,m,!1);if(-1===K||-1===L)return 0;for(var M=0;2>M;M++){var N=K,O=L,P=f,Q=t,R=n,S=l,T=d,U=r,V=e,W=i;if(0===M){var X;X=N,N=O,O=X,X=P,P=Q,Q=X,X=R,R=S,S=X,X=T,T=U,U=X,X=V,V=W,W=X}for(var Y=O;O+2>Y;Y++){var Z=Q.vertices[(Y+Q.vertices.length)%Q.vertices.length];p.toGlobalFrame(x,Z,S,U);for(var $=0,_=N-1;N+2>_;_++){var ee=(_+P.vertices.length)%P.vertices.length,fe=P.vertices[ee],ne=P.vertices[(ee+1)%P.vertices.length];p.toGlobalFrame(j,fe,R,T),y(z,P.normals[ee],T),u(q,x,j);var oe=c(z,q);(_===N&&g>=oe||_!==N&&0>=oe)&&$++}if($>=3){if(b)return!0;var de=this.createContactEquation(V,W,P,Q);F++;var fe=P.vertices[N%P.vertices.length],ne=P.vertices[(N+1)%P.vertices.length];y(j,fe,T),y(v,ne,T),s(j,j,R),s(v,v,R),u(h,v,j),p.rotate90cw(de.normalA,h),a(de.normalA,de.normalA),u(q,x,j);var oe=c(de.normalA,q);w(k,de.normalA,oe),u(de.contactPointA,x,R),u(de.contactPointA,de.contactPointA,k),s(de.contactPointA,de.contactPointA,R),u(de.contactPointA,de.contactPointA,V.position),u(de.contactPointB,x,S),s(de.contactPointB,de.contactPointB,S),u(de.contactPointB,de.contactPointB,W.position),this.contactEquations.push(de),this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(de))}}}return this.enableFrictionReduction&&this.enableFriction&&F&&this.frictionEquations.push(this.createFrictionFromAverage(F)),F};var fe=g();o.projectConvexOntoAxis=function(e,f,n,o,d){var i,t,l,u,s=e.vertices,a=fe;y(a,o,-n),u=t=i=c(s[0],a);for(var r=1,w=s.length;w>r;r++)l=s[r],u=c(l,a),u>i&&(i=u),t>u&&(t=u);if(t>i){var b=t;t=i,i=b}var g=c(f,o);p.set(d,t+g,i+g)};var ne=g(),oe=g(),de=g();o.findSeparatingAxis=function(e,f,n,d,i,t,l){var u=null,s=!1,c=!1,a=ne,w=oe,b=de;if(e instanceof q&&d instanceof q)for(var g=0;2!==g;g++){var m=e,x=n;1===g&&(m=d,x=t);for(var j=0;2!==j;j++){0===j?p.set(a,0,1):1===j&&p.set(a,1,0),0!==x&&y(a,a,x),o.projectConvexOntoAxis(e,f,n,a,w),o.projectConvexOntoAxis(d,i,t,a,b);var v=w,h=b,k=!1;w[0]>b[0]&&(h=w,v=b,k=!0);var z=h[0]-v[1];s=0>=z,(null===u||z>u)&&(r(l,a),u=z,c=s)}}else for(var g=0;2!==g;g++){var m=e,x=n;1===g&&(m=d,x=t);for(var j=0;j!==m.vertices.length;j++){y(a,m.normals[j],x),o.projectConvexOntoAxis(e,f,n,a,w),o.projectConvexOntoAxis(d,i,t,a,b);var v=w,h=b,k=!1;w[0]>b[0]&&(h=w,v=b,k=!0);var z=h[0]-v[1];s=0>=z,(null===u||z>u)&&(r(l,a),u=z,c=s)}}return c};var ie=g();o.getClosestEdge=function(e,f,n,o){var d,i=ie;y(i,n,-f+(o?Math.PI:0));for(var t=0,l=e.vertices.length,p=c(e.normals[0],i),u=1;u!==l;u++){d=e.normals[u];var s=c(d,i);s>p&&(t=u,p=s)}return t};var te=g(),le=g(),pe=g(),ue=g(),se=g(),ce=g(),ye=g();o.prototype[k.CIRCLE|k.HEIGHTFIELD]=o.prototype.circleHeightfield=function(e,f,n,o,d,i,t,l,g,m){var x=i.heights,m=m||f.radius,j=i.elementWidth,v=le,h=te,k=se,q=ye,z=ce,A=pe,B=ue,C=Math.floor((n[0]-m-t[0])/j),D=Math.ceil((n[0]+m-t[0])/j);0>C&&(C=0),D>=x.length&&(D=x.length-1);for(var E=x[C],F=x[D],G=C;D>G;G++)x[G]<F&&(F=x[G]),x[G]>E&&(E=x[G]);if(n[1]-m>E)return g?!1:0;for(var H=!1,G=C;D>G;G++){p.set(A,G*j,x[G]),p.set(B,(G+1)*j,x[G+1]),s(A,A,t),s(B,B,t),u(z,B,A),y(z,z,Math.PI/2),a(z,z),w(h,z,-m),s(h,h,n),u(v,h,A);var I=c(v,z);if(h[0]>=A[0]&&h[0]<B[0]&&0>=I){if(g)return!0;H=!0,w(v,z,-I),s(k,h,v),r(q,z);var J=this.createContactEquation(d,e,i,f);r(J.normalA,q),w(J.contactPointB,J.normalA,-m),s(J.contactPointB,J.contactPointB,n),u(J.contactPointB,J.contactPointB,e.position),r(J.contactPointA,k),u(J.contactPointA,J.contactPointA,d.position),this.contactEquations.push(J),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(J))}}if(H=!1,m>0)for(var G=C;D>=G;G++)if(p.set(A,G*j,x[G]),s(A,A,t),u(v,n,A),b(v)<Math.pow(m,2)){if(g)return!0;H=!0;var J=this.createContactEquation(d,e,i,f);r(J.normalA,v),a(J.normalA,J.normalA),w(J.contactPointB,J.normalA,-m),s(J.contactPointB,J.contactPointB,n),u(J.contactPointB,J.contactPointB,e.position),u(J.contactPointA,A,t),s(J.contactPointA,J.contactPointA,t),u(J.contactPointA,J.contactPointA,d.position),this.contactEquations.push(J),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(J))}return H?1:0};var ae=g(),re=g(),we=g(),be=new h({vertices:[g(),g(),g(),g()]});o.prototype[k.BOX|k.HEIGHTFIELD]=o.prototype[k.CONVEX|k.HEIGHTFIELD]=o.prototype.convexHeightfield=function(e,f,n,o,d,i,t,l,c){var y=i.heights,a=i.elementWidth,w=ae,b=re,g=we,m=be,x=Math.floor((e.aabb.lowerBound[0]-t[0])/a),j=Math.ceil((e.aabb.upperBound[0]-t[0])/a);0>x&&(x=0),j>=y.length&&(j=y.length-1);for(var v=y[x],h=y[j],k=x;j>k;k++)y[k]<h&&(h=y[k]),y[k]>v&&(v=y[k]);if(e.aabb.lowerBound[1]>v)return c?!1:0;for(var q=0,k=x;j>k;k++){p.set(w,k*a,y[k]),p.set(b,(k+1)*a,y[k+1]),s(w,w,t),s(b,b,t);var z=100;p.set(g,.5*(b[0]+w[0]),.5*(b[1]+w[1]-z)),u(m.vertices[0],b,g),u(m.vertices[1],w,g),r(m.vertices[2],m.vertices[1]),r(m.vertices[3],m.vertices[0]),m.vertices[2][1]-=z,m.vertices[3][1]-=z,q+=this.convexConvex(e,f,n,o,d,m,g,0,c)}return q}},{"../math/vec2":29,"../shapes/Box":36,"../shapes/Circle":38,"../shapes/Convex":39,"../shapes/Shape":44,"../utils/ContactEquationPool":47,"../utils/FrictionEquationPool":48,"../utils/TupleDictionary":55}],10:[function(e,f,n){function o(e){e=e||{},this.from=e.from?i.clone(e.from):i.create(),this.to=e.to?i.clone(e.to):i.create(),this.checkCollisionResponse=void 0!==e.checkCollisionResponse?e.checkCollisionResponse:!0,this.skipBackfaces=!!e.skipBackfaces,this.collisionMask=void 0!==e.collisionMask?e.collisionMask:-1,this.collisionGroup=void 0!==e.collisionGroup?e.collisionGroup:-1,this.mode=void 0!==e.mode?e.mode:o.ANY,this.callback=e.callback||function(){},this.direction=i.create(),this.length=1,this.update()}function d(e,f,n){i.sub(l,n,e);var o=i.dot(l,f);return i.scale(p,f,o),i.add(p,p,e),i.squaredDistance(n,p)}f.exports=o;var i=e("../math/vec2");o.prototype.constructor=o,o.CLOSEST=1,o.ANY=2,o.ALL=4,o.prototype.update=function(){var e=this.direction;i.sub(e,this.to,this.from),this.length=i.length(e),i.normalize(e,e)},o.prototype.intersectBodies=function(e,f){for(var n=0,o=f.length;!e.shouldStop(this)&&o>n;n++){var d=f[n],i=d.getAABB();(i.overlapsRay(this)>=0||i.containsPoint(this.from))&&this.intersectBody(e,d)}};var t=i.create();o.prototype.intersectBody=function(e,f){var n=this.checkCollisionResponse;if(!n||f.collisionResponse)for(var o=t,d=0,l=f.shapes.length;l>d;d++){var p=f.shapes[d];if((!n||p.collisionResponse)&&0!==(this.collisionGroup&p.collisionMask)&&0!==(p.collisionGroup&this.collisionMask)){
i.rotate(o,p.position,f.angle),i.add(o,o,f.position);var u=p.angle+f.angle;if(this.intersectShape(e,p,u,o,f),e.shouldStop(this))break}}},o.prototype.intersectShape=function(e,f,n,o,i){var t=this.from,l=d(t,this.direction,o);l>f.boundingRadius*f.boundingRadius||(this._currentBody=i,this._currentShape=f,f.raycast(e,this,o,n),this._currentBody=this._currentShape=null)},o.prototype.getAABB=function(e){var f=this.to,n=this.from;i.set(e.lowerBound,Math.min(f[0],n[0]),Math.min(f[1],n[1])),i.set(e.upperBound,Math.max(f[0],n[0]),Math.max(f[1],n[1]))},o.prototype.reportIntersection=function(e,f,n,d){var t=this._currentShape,l=this._currentBody;if(!(this.skipBackfaces&&i.dot(n,this.direction)>0))switch(this.mode){case o.ALL:e.set(n,t,l,f,d),this.callback(e);break;case o.CLOSEST:(f<e.fraction||!e.hasHit())&&e.set(n,t,l,f,d);break;case o.ANY:e.set(n,t,l,f,d)}};var l=i.create(),p=i.create()},{"../math/vec2":29}],11:[function(e,f,n){function o(){this.normal=d.create(),this.shape=null,this.body=null,this.faceIndex=-1,this.fraction=-1,this.isStopped=!1}var d=e("../math/vec2"),i=e("../collision/Ray");f.exports=o,o.prototype.reset=function(){d.set(this.normal,0,0),this.shape=null,this.body=null,this.faceIndex=-1,this.fraction=-1,this.isStopped=!1},o.prototype.getHitDistance=function(e){return d.distance(e.from,e.to)*this.fraction},o.prototype.hasHit=function(){return-1!==this.fraction},o.prototype.getHitPoint=function(e,f){d.lerp(e,f.from,f.to,this.fraction)},o.prototype.stop=function(){this.isStopped=!0},o.prototype.shouldStop=function(e){return this.isStopped||-1!==this.fraction&&e.mode===i.ANY},o.prototype.set=function(e,f,n,o,i){d.copy(this.normal,e),this.shape=f,this.body=n,this.fraction=o,this.faceIndex=i}},{"../collision/Ray":10,"../math/vec2":29}],12:[function(e,f,n){function o(){i.call(this,i.SAP),this.axisList=[],this.axisIndex=0;var e=this;this._addBodyHandler=function(f){e.axisList.push(f.body)},this._removeBodyHandler=function(f){var n=e.axisList.indexOf(f.body);-1!==n&&e.axisList.splice(n,1)}}var d=e("../utils/Utils"),i=e("../collision/Broadphase");f.exports=o,o.prototype=new i,o.prototype.constructor=o,o.prototype.setWorld=function(e){this.axisList.length=0,d.appendArray(this.axisList,e.bodies),e.off("addBody",this._addBodyHandler).off("removeBody",this._removeBodyHandler),e.on("addBody",this._addBodyHandler).on("removeBody",this._removeBodyHandler),this.world=e},o.sortAxisList=function(e,f){f=0|f;for(var n=1,o=e.length;o>n;n++){for(var d=e[n],i=n-1;i>=0&&!(e[i].aabb.lowerBound[f]<=d.aabb.lowerBound[f]);i--)e[i+1]=e[i];e[i+1]=d}return e},o.prototype.sortList=function(){var e=this.axisList,f=this.axisIndex;o.sortAxisList(e,f)},o.prototype.getCollisionPairs=function(){var e=this.axisList,f=this.result,n=this.axisIndex;f.length=0;for(var o=e.length;o--;){var d=e[o];d.aabbNeedsUpdate&&d.updateAABB()}this.sortList();for(var t=0,l=0|e.length;t!==l;t++)for(var p=e[t],u=t+1;l>u;u++){var s=e[u],c=s.aabb.lowerBound[n]<=p.aabb.upperBound[n];if(!c)break;i.canCollide(p,s)&&this.boundingVolumeCheck(p,s)&&f.push(p,s)}return f},o.prototype.aabbQuery=function(e,f,n){n=n||[],this.sortList();for(var o=this.axisList,d=0;d<o.length;d++){var i=o[d];i.aabbNeedsUpdate&&i.updateAABB(),i.aabb.overlaps(f)&&n.push(i)}return n}},{"../collision/Broadphase":7,"../utils/Utils":56}],13:[function(e,f,n){function o(e,f,n,o){o=o||{},this.type=n,this.equations=[],this.bodyA=e,this.bodyB=f,this.collideConnected=void 0!==o.collideConnected?o.collideConnected:!0,o.wakeUpBodies!==!1&&(e&&e.wakeUp(),f&&f.wakeUp())}f.exports=o,o.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},o.DISTANCE=1,o.GEAR=2,o.LOCK=3,o.PRISMATIC=4,o.REVOLUTE=5,o.prototype.setStiffness=function(e){for(var f=this.equations,n=0;n!==f.length;n++){var o=f[n];o.stiffness=e,o.needsUpdate=!0}},o.prototype.setRelaxation=function(e){for(var f=this.equations,n=0;n!==f.length;n++){var o=f[n];o.relaxation=e,o.needsUpdate=!0}},o.prototype.setMaxBias=function(e){for(var f=this.equations,n=0;n!==f.length;n++){var o=f[n];o.maxBias=e}}},{}],14:[function(e,f,n){function o(e,f,n){n=n||{},d.call(this,e,f,d.DISTANCE,n),this.localAnchorA=n.localAnchorA?t.clone(n.localAnchorA):t.create(),this.localAnchorB=n.localAnchorB?t.clone(n.localAnchorB):t.create();var o=this.localAnchorA,l=this.localAnchorB;if(this.distance=0,"number"==typeof n.distance)this.distance=n.distance;else{var p=t.create(),u=t.create(),s=t.create();t.rotate(p,o,e.angle),t.rotate(u,l,f.angle),t.add(s,f.position,u),t.sub(s,s,p),t.sub(s,s,e.position),this.distance=t.length(s)}var c;c="undefined"==typeof n.maxForce?Number.MAX_VALUE:n.maxForce;var y=new i(e,f,-c,c);this.equations=[y],this.maxForce=c;var s=t.create(),a=t.create(),r=t.create(),w=this;y.computeGq=function(){var e=this.bodyA,f=this.bodyB,n=e.position,d=f.position;return t.rotate(a,o,e.angle),t.rotate(r,l,f.angle),t.add(s,d,r),t.sub(s,s,a),t.sub(s,s,n),t.length(s)-w.distance},this.setMaxForce(c),this.upperLimitEnabled=!1,this.upperLimit=1,this.lowerLimitEnabled=!1,this.lowerLimit=0,this.position=0}var d=e("./Constraint"),i=e("../equations/Equation"),t=e("../math/vec2");f.exports=o,o.prototype=new d,o.prototype.constructor=o;var l=t.create(),p=t.create(),u=t.create();o.prototype.update=function(){var e=this.equations[0],f=this.bodyA,n=this.bodyB,o=f.position,d=n.position,i=this.equations[0],s=e.G;t.rotate(p,this.localAnchorA,f.angle),t.rotate(u,this.localAnchorB,n.angle),t.add(l,d,u),t.sub(l,l,p),t.sub(l,l,o),this.position=t.length(l);var c=!1;if(this.upperLimitEnabled&&this.position>this.upperLimit&&(i.maxForce=0,i.minForce=-this.maxForce,this.distance=this.upperLimit,c=!0),this.lowerLimitEnabled&&this.position<this.lowerLimit&&(i.maxForce=this.maxForce,i.minForce=0,this.distance=this.lowerLimit,c=!0),(this.lowerLimitEnabled||this.upperLimitEnabled)&&!c)return void(i.enabled=!1);i.enabled=!0,t.normalize(l,l);var y=t.crossLength(p,l),a=t.crossLength(u,l);s[0]=-l[0],s[1]=-l[1],s[2]=-y,s[3]=l[0],s[4]=l[1],s[5]=a},o.prototype.setMaxForce=function(e){var f=this.equations[0];f.minForce=-e,f.maxForce=e},o.prototype.getMaxForce=function(){var e=this.equations[0];return e.maxForce}},{"../equations/Equation":21,"../math/vec2":29,"./Constraint":13}],15:[function(e,f,n){function o(e,f,n){n=n||{},d.call(this,e,f,d.GEAR,n),this.ratio=void 0!==n.ratio?n.ratio:1,this.angle=void 0!==n.angle?n.angle:f.angle-this.ratio*e.angle;var o=t.shallowClone(n);o.angle=this.angle,o.ratio=this.ratio,this.equations=[new i(e,f,o)],void 0!==n.maxTorque&&this.setMaxTorque(n.maxTorque)}var d=e("./Constraint"),i=e("../equations/AngleLockEquation"),t=e("../utils/Utils");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.update=function(){var e=this.equations[0],f=this.ratio;e.ratio!==f&&e.setRatio(f),e.angle=this.angle},o.prototype.setMaxTorque=function(e){this.equations[0].setMaxTorque(e)},o.prototype.getMaxTorque=function(){return this.equations[0].maxForce}},{"../equations/AngleLockEquation":19,"../utils/Utils":56,"./Constraint":13}],16:[function(e,f,n){function o(e,f,n){n=n||{},d.call(this,e,f,d.LOCK,n);var o="undefined"==typeof n.maxForce?Number.MAX_VALUE:n.maxForce,l=new t(e,f,-o,o),p=new t(e,f,-o,o),u=new t(e,f,-o,o),s=i.create(),c=i.create(),y=this;l.computeGq=function(){return i.rotate(s,y.localOffsetB,e.angle),i.sub(c,f.position,e.position),i.sub(c,c,s),c[0]},p.computeGq=function(){return i.rotate(s,y.localOffsetB,e.angle),i.sub(c,f.position,e.position),i.sub(c,c,s),c[1]};var a=i.create(),r=i.create();u.computeGq=function(){return i.rotate(a,y.localOffsetB,f.angle-y.localAngleB),i.scale(a,a,-1),i.sub(c,e.position,f.position),i.add(c,c,a),i.rotate(r,a,-Math.PI/2),i.normalize(r,r),i.dot(c,r)},this.localOffsetB=i.create(),n.localOffsetB?i.copy(this.localOffsetB,n.localOffsetB):(i.sub(this.localOffsetB,f.position,e.position),i.rotate(this.localOffsetB,this.localOffsetB,-e.angle)),this.localAngleB=0,"number"==typeof n.localAngleB?this.localAngleB=n.localAngleB:this.localAngleB=f.angle-e.angle,this.equations.push(l,p,u),this.setMaxForce(o)}var d=e("./Constraint"),i=e("../math/vec2"),t=e("../equations/Equation");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.setMaxForce=function(e){for(var f=this.equations,n=0;n<this.equations.length;n++)f[n].maxForce=e,f[n].minForce=-e},o.prototype.getMaxForce=function(){return this.equations[0].maxForce};var l=i.create(),p=i.create(),u=i.create(),s=i.fromValues(1,0),c=i.fromValues(0,1);o.prototype.update=function(){var e=this.equations[0],f=this.equations[1],n=this.equations[2],o=this.bodyA,d=this.bodyB;i.rotate(l,this.localOffsetB,o.angle),i.rotate(p,this.localOffsetB,d.angle-this.localAngleB),i.scale(p,p,-1),i.rotate(u,p,Math.PI/2),i.normalize(u,u),e.G[0]=-1,e.G[1]=0,e.G[2]=-i.crossLength(l,s),e.G[3]=1,f.G[0]=0,f.G[1]=-1,f.G[2]=-i.crossLength(l,c),f.G[4]=1,n.G[0]=-u[0],n.G[1]=-u[1],n.G[3]=u[0],n.G[4]=u[1],n.G[5]=i.crossLength(p,u)}},{"../equations/Equation":21,"../math/vec2":29,"./Constraint":13}],17:[function(e,f,n){function o(e,f,n){n=n||{},d.call(this,e,f,d.PRISMATIC,n);var o=l.create(),u=l.fromValues(1,0),s=l.create();n.localAnchorA&&l.copy(o,n.localAnchorA),n.localAxisA&&l.copy(u,n.localAxisA),n.localAnchorB&&l.copy(s,n.localAnchorB),this.localAnchorA=o,this.localAnchorB=s,this.localAxisA=u;var c=this.maxForce="undefined"!=typeof n.maxForce?n.maxForce:Number.MAX_VALUE,y=new t(e,f,-c,c),a=new l.create,r=new l.create,w=new l.create,b=new l.create;if(y.computeGq=function(){return l.dot(w,b)},y.updateJacobian=function(){var n=this.G,d=e.position,i=f.position;l.rotate(a,o,e.angle),l.rotate(r,s,f.angle),l.add(w,i,r),l.sub(w,w,d),l.sub(w,w,a),l.rotate(b,u,e.angle+Math.PI/2),n[0]=-b[0],n[1]=-b[1],n[2]=-l.crossLength(a,b)+l.crossLength(b,w),n[3]=b[0],n[4]=b[1],n[5]=l.crossLength(r,b)},this.equations.push(y),!n.disableRotationalLock){var g=new p(e,f,-c,c);this.equations.push(g)}this.position=0,this.velocity=0,this.lowerLimitEnabled="undefined"!=typeof n.lowerLimit?!0:!1,this.upperLimitEnabled="undefined"!=typeof n.upperLimit?!0:!1,this.lowerLimit="undefined"!=typeof n.lowerLimit?n.lowerLimit:0,this.upperLimit="undefined"!=typeof n.upperLimit?n.upperLimit:1,this.upperLimitEquation=new i(e,f),this.lowerLimitEquation=new i(e,f),this.upperLimitEquation.minForce=this.lowerLimitEquation.minForce=0,this.upperLimitEquation.maxForce=this.lowerLimitEquation.maxForce=c,this.motorEquation=new t(e,f),this.motorEnabled=!1,this.motorSpeed=0;var m=this,x=this.motorEquation;x.computeGq=function(){return 0},x.computeGW=function(){var e=this.G,f=this.bodyA,n=this.bodyB,o=f.velocity,d=n.velocity,i=f.angularVelocity,t=n.angularVelocity;return this.gmult(e,o,i,d,t)+m.motorSpeed}}var d=e("./Constraint"),i=e("../equations/ContactEquation"),t=e("../equations/Equation"),l=e("../math/vec2"),p=e("../equations/RotationalLockEquation");f.exports=o,o.prototype=new d,o.prototype.constructor=o;var u=l.create(),s=l.create(),c=l.create(),y=l.create(),a=l.create(),r=l.create();o.prototype.update=function(){var e=this.equations,f=e[0],n=this.upperLimit,o=this.lowerLimit,d=this.upperLimitEquation,i=this.lowerLimitEquation,t=this.bodyA,p=this.bodyB,w=this.localAxisA,b=this.localAnchorA,g=this.localAnchorB;f.updateJacobian(),l.rotate(u,w,t.angle),l.rotate(y,b,t.angle),l.add(s,y,t.position),l.rotate(a,g,p.angle),l.add(c,a,p.position);var m=this.position=l.dot(c,u)-l.dot(s,u);if(this.motorEnabled){var x=this.motorEquation.G;x[0]=u[0],x[1]=u[1],x[2]=l.crossLength(u,a),x[3]=-u[0],x[4]=-u[1],x[5]=-l.crossLength(u,y)}if(this.upperLimitEnabled&&m>n)l.scale(d.normalA,u,-1),l.sub(d.contactPointA,s,t.position),l.sub(d.contactPointB,c,p.position),l.scale(r,u,n),l.add(d.contactPointA,d.contactPointA,r),-1===e.indexOf(d)&&e.push(d);else{var j=e.indexOf(d);-1!==j&&e.splice(j,1)}if(this.lowerLimitEnabled&&o>m)l.scale(i.normalA,u,1),l.sub(i.contactPointA,s,t.position),l.sub(i.contactPointB,c,p.position),l.scale(r,u,o),l.sub(i.contactPointB,i.contactPointB,r),-1===e.indexOf(i)&&e.push(i);else{var j=e.indexOf(i);-1!==j&&e.splice(j,1)}},o.prototype.enableMotor=function(){this.motorEnabled||(this.equations.push(this.motorEquation),this.motorEnabled=!0)},o.prototype.disableMotor=function(){if(this.motorEnabled){var e=this.equations.indexOf(this.motorEquation);this.equations.splice(e,1),this.motorEnabled=!1}},o.prototype.setLimits=function(e,f){"number"==typeof e?(this.lowerLimit=e,this.lowerLimitEnabled=!0):(this.lowerLimit=e,this.lowerLimitEnabled=!1),"number"==typeof f?(this.upperLimit=f,this.upperLimitEnabled=!0):(this.upperLimit=f,this.upperLimitEnabled=!1)}},{"../equations/ContactEquation":20,"../equations/Equation":21,"../equations/RotationalLockEquation":23,"../math/vec2":29,"./Constraint":13}],18:[function(e,f,n){function o(e,f,n){n=n||{},d.call(this,e,f,d.REVOLUTE,n);var o=this.maxForce=void 0!==n.maxForce?n.maxForce:Number.MAX_VALUE,r=this.pivotA=p.create(),j=this.pivotB=p.create();n.worldPivot?(u(r,n.worldPivot,e.position),u(j,n.worldPivot,f.position),c(r,r,-e.angle),c(j,j,-f.angle)):(n.localPivotA&&a(r,n.localPivotA),n.localPivotB&&a(j,n.localPivotB));var v=this.motorEquation=new t(e,f);v.enabled=!1;var h=this.upperLimitEquation=new l(e,f),k=this.lowerLimitEquation=new l(e,f);h.minForce=k.maxForce=0;var q=this.equations=[new i(e,f,-o,o),new i(e,f,-o,o),v,h,k],z=q[0],A=q[1];z.computeGq=function(){return c(w,r,e.angle),c(b,j,f.angle),s(x,f.position,b),u(x,x,e.position),u(x,x,w),y(x,g)},A.computeGq=function(){return c(w,r,e.angle),c(b,j,f.angle),s(x,f.position,b),u(x,x,e.position),u(x,x,w),y(x,m)},A.minForce=z.minForce=-o,A.maxForce=z.maxForce=o,z.G[0]=-1,z.G[1]=0,z.G[3]=1,z.G[4]=0,A.G[0]=0,A.G[1]=-1,A.G[3]=0,A.G[4]=1,this.angle=0,this.lowerLimitEnabled=!1,this.upperLimitEnabled=!1,this.lowerLimit=0,this.upperLimit=0}var d=e("./Constraint"),i=e("../equations/Equation"),t=e("../equations/RotationalVelocityEquation"),l=e("../equations/RotationalLockEquation"),p=e("../math/vec2"),u=p.sub,s=p.add,c=p.rotate,y=p.dot,a=p.copy,r=p.crossLength;f.exports=o;var w=p.create(),b=p.create(),g=p.fromValues(1,0),m=p.fromValues(0,1),x=p.create();o.prototype=new d,o.prototype.constructor=o,o.prototype.setLimits=function(e,f){this.lowerLimit=e,this.upperLimit=f,this.lowerLimitEnabled=this.upperLimitEnabled=!0},o.prototype.update=function(){var e=this.bodyA,f=this.bodyB,n=this.pivotA,o=this.pivotB,d=this.equations,i=d[0],t=d[1],l=this.upperLimit,p=this.lowerLimit,u=this.upperLimitEquation,s=this.lowerLimitEquation,y=this.angle=f.angle-e.angle;u.angle=l,u.enabled=this.upperLimitEnabled&&y>l,s.angle=p,s.enabled=this.lowerLimitEnabled&&p>y,c(w,n,e.angle),c(b,o,f.angle);var a=i.G;a[2]=-r(w,g),a[5]=r(b,g);var x=t.G;x[2]=-r(w,m),x[5]=r(b,m)},Object.defineProperties(o.prototype,{motorEnabled:{get:function(){return this.motorEquation.enabled},set:function(e){this.motorEquation.enabled=e}},motorSpeed:{get:function(){return this.motorEquation.relativeVelocity},set:function(e){this.motorEquation.relativeVelocity=e}},motorMaxForce:{get:function(){return this.motorEquation.maxForce},set:function(e){var f=this.motorEquation;f.maxForce=e,f.minForce=-e}}}),o.prototype.enableMotor=function(){this.motorEnabled=!0},o.prototype.disableMotor=function(){this.motorEnabled=!1},o.prototype.motorIsEnabled=function(){return this.motorEnabled},o.prototype.setMotorSpeed=function(e){this.motorSpeed=e},o.prototype.getMotorSpeed=function(){return this.motorSpeed}},{"../equations/Equation":21,"../equations/RotationalLockEquation":23,"../equations/RotationalVelocityEquation":24,"../math/vec2":29,"./Constraint":13}],19:[function(e,f,n){function o(e,f,n){n=n||{},d.call(this,e,f,-Number.MAX_VALUE,Number.MAX_VALUE),this.angle=n.angle||0,this.ratio=void 0!==n.ratio?n.ratio:1,this.setRatio(this.ratio)}var d=e("./Equation");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.computeGq=function(){return this.ratio*this.bodyA.angle-this.bodyB.angle+this.angle},o.prototype.setRatio=function(e){var f=this.G;f[2]=e,f[5]=-1,this.ratio=e},o.prototype.setMaxTorque=function(e){this.maxForce=e,this.minForce=-e}},{"./Equation":21}],20:[function(e,f,n){function o(e,f){i.call(this,e,f,0,Number.MAX_VALUE),this.contactPointA=t.create(),this.penetrationVec=t.create(),this.contactPointB=t.create(),this.normalA=t.create(),this.restitution=0,this.firstImpact=!1,this.shapeA=null,this.shapeB=null}function d(e,f,n,o,d){e[0]=f[0]+n[0]-o[0]-d[0],e[1]=f[1]+n[1]-o[1]-d[1]}var i=e("./Equation"),t=e("../math/vec2");f.exports=o,o.prototype=new i,o.prototype.constructor=o,o.prototype.computeB=function(e,f,n){var o=this.bodyA,i=this.bodyB,l=this.contactPointA,p=this.contactPointB,u=o.position,s=i.position,c=this.normalA,y=this.G,a=t.crossLength(l,c),r=t.crossLength(p,c);y[0]=-c[0],y[1]=-c[1],y[2]=-a,y[3]=c[0],y[4]=c[1],y[5]=r;var w,b;if(this.firstImpact&&0!==this.restitution)b=0,w=1/f*(1+this.restitution)*this.computeGW();else{var g=this.penetrationVec;d(g,s,p,u,l),b=t.dot(c,g)+this.offset,w=this.computeGW()}var m=this.computeGiMf(),x=-b*e-w*f-n*m;return x};var l=t.create(),p=t.create(),u=t.create();o.prototype.getVelocityAlongNormal=function(){return this.bodyA.getVelocityAtPoint(l,this.contactPointA),this.bodyB.getVelocityAtPoint(p,this.contactPointB),t.subtract(u,l,p),t.dot(this.normalA,u)}},{"../math/vec2":29,"./Equation":21}],21:[function(e,f,n){function o(e,f,n,d){this.minForce=void 0===n?-Number.MAX_VALUE:n,this.maxForce=void 0===d?Number.MAX_VALUE:d,this.maxBias=Number.MAX_VALUE,this.bodyA=e,this.bodyB=f,this.stiffness=o.DEFAULT_STIFFNESS,this.relaxation=o.DEFAULT_RELAXATION,this.G=new u.ARRAY_TYPE(6);for(var i=0;6>i;i++)this.G[i]=0;this.offset=0,this.a=0,this.b=0,this.epsilon=0,this.timeStep=1/60,this.needsUpdate=!0,this.multiplier=0,this.relativeVelocity=0,this.enabled=!0,this.lambda=this.B=this.invC=this.minForceDt=this.maxForceDt=0}function d(e,f,n,o,d,i){e[0]+=f*o*d*i[0],e[1]+=n*o*d*i[1]}f.exports=o;var i=e("../math/vec2"),t=i.scale,l=i.multiply,p=i.create,u=e("../utils/Utils");o.DEFAULT_STIFFNESS=1e6,o.DEFAULT_RELAXATION=4;var s=p(),c=p(),y=p(),a=p();o.prototype={update:function(){var e=this.stiffness,f=this.relaxation,n=this.timeStep;this.a=4/(n*(1+4*f)),this.b=4*f/(1+4*f),this.epsilon=4/(n*n*e*(1+4*f)),this.needsUpdate=!1},gmult:function(e,f,n,o,d){return e[0]*f[0]+e[1]*f[1]+e[2]*n+e[3]*o[0]+e[4]*o[1]+e[5]*d},computeB:function(e,f,n){var o=this.computeGW(),d=this.computeGq(),i=this.maxBias;Math.abs(d)>i&&(d=d>0?i:-i);var t=this.computeGiMf(),l=-d*e-o*f-t*n;return l},computeGq:function(){var e=this.G,f=this.bodyA,n=this.bodyB,o=f.angle,d=n.angle;return this.gmult(e,s,o,c,d)+this.offset},computeGW:function(){var e=this.G,f=this.bodyA,n=this.bodyB,o=f.velocity,d=n.velocity,i=f.angularVelocity,t=n.angularVelocity;return this.gmult(e,o,i,d,t)+this.relativeVelocity},computeGWlambda:function(){var e=this.G,f=this.bodyA,n=this.bodyB,o=f.vlambda,d=n.vlambda,i=f.wlambda,t=n.wlambda;return this.gmult(e,o,i,d,t)},computeGiMf:function(){var e=this.bodyA,f=this.bodyB,n=e.force,o=e.angularForce,d=f.force,i=f.angularForce,p=e.invMassSolve,u=f.invMassSolve,s=e.invInertiaSolve,c=f.invInertiaSolve,r=this.G;return t(y,n,p),l(y,e.massMultiplier,y),t(a,d,u),l(a,f.massMultiplier,a),this.gmult(r,y,o*s,a,i*c)},computeGiMGt:function(){var e=this.bodyA,f=this.bodyB,n=e.invMassSolve,o=f.invMassSolve,d=e.invInertiaSolve,i=f.invInertiaSolve,t=this.G;return t[0]*t[0]*n*e.massMultiplier[0]+t[1]*t[1]*n*e.massMultiplier[1]+t[2]*t[2]*d+t[3]*t[3]*o*f.massMultiplier[0]+t[4]*t[4]*o*f.massMultiplier[1]+t[5]*t[5]*i},addToWlambda:function(e){var f=this.bodyA,n=this.bodyB,o=f.invMassSolve,i=n.invMassSolve,t=f.invInertiaSolve,l=n.invInertiaSolve,p=this.G;d(f.vlambda,p[0],p[1],o,e,f.massMultiplier),f.wlambda+=t*p[2]*e,d(n.vlambda,p[3],p[4],i,e,n.massMultiplier),n.wlambda+=l*p[5]*e},computeInvC:function(e){var f=1/(this.computeGiMGt()+e);return f}}},{"../math/vec2":29,"../utils/Utils":56}],22:[function(e,f,n){function o(e,f,n){i.call(this,e,f,-n,n),this.contactPointA=d.create(),this.contactPointB=d.create(),this.t=d.create(),this.contactEquations=[],this.shapeA=null,this.shapeB=null,this.frictionCoefficient=.3}var d=e("../math/vec2"),i=e("./Equation");f.exports=o,o.prototype=new i,o.prototype.constructor=o,o.prototype.setSlipForce=function(e){this.maxForce=e,this.minForce=-e},o.prototype.getSlipForce=function(){return this.maxForce},o.prototype.computeB=function(e,f,n){var o=this.contactPointA,i=this.contactPointB,t=this.t,l=this.G;l[0]=-t[0],l[1]=-t[1],l[2]=-d.crossLength(o,t),l[3]=t[0],l[4]=t[1],l[5]=d.crossLength(i,t);var p=this.computeGW(),u=this.computeGiMf(),s=-p*f-n*u;return s}},{"../math/vec2":29,"./Equation":21}],23:[function(e,f,n){function o(e,f,n){n=n||{},d.call(this,e,f,-Number.MAX_VALUE,Number.MAX_VALUE),this.angle=n.angle||0;var o=this.G;o[2]=1,o[5]=-1}var d=e("./Equation"),i=e("../math/vec2");f.exports=o,o.prototype=new d,o.prototype.constructor=o;var t=i.create(),l=i.create(),p=i.fromValues(1,0),u=i.fromValues(0,1);o.prototype.computeGq=function(){return i.rotate(t,p,this.bodyA.angle+this.angle),i.rotate(l,u,this.bodyB.angle),i.dot(t,l)}},{"../math/vec2":29,"./Equation":21}],24:[function(e,f,n){function o(e,f){d.call(this,e,f,-Number.MAX_VALUE,Number.MAX_VALUE),this.relativeVelocity=1,this.ratio=1}var d=e("./Equation");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.computeB=function(e,f,n){var o=this.G;o[2]=-1,o[5]=this.ratio;var d=this.computeGiMf(),i=this.computeGW(),t=-i*f-n*d;return t}},{"./Equation":21}],25:[function(e,f,n){function o(){this.tmpArray=[]}f.exports=o,o.prototype={constructor:o,on:function(e,f,n){f.context=n||this,void 0===this._listeners&&(this._listeners={});var o=this._listeners;return void 0===o[e]&&(o[e]=[]),-1===o[e].indexOf(f)&&o[e].push(f),this},has:function(e,f){if(void 0===this._listeners)return!1;var n=this._listeners;if(f){if(void 0!==n[e]&&-1!==n[e].indexOf(f))return!0}else if(void 0!==n[e])return!0;return!1},off:function(e,f){var n=this._listeners;if(!n||!n[e])return this;var o=n[e].indexOf(f);return-1!==o&&n[e].splice(o,1),this},emit:function(e){if(void 0===this._listeners)return this;var f=this._listeners,n=f[e.type];if(void 0!==n){e.target=this;for(var o=this.tmpArray,d=0,i=n.length;i>d;d++)o[d]=n[d];for(var d=0,i=o.length;i>d;d++){var t=o[d];t.call(t.context,e)}o.length=0}return this}}},{}],26:[function(e,f,n){function o(e,f,n){if(n=n||{},!(e instanceof d&&f instanceof d))throw new Error("First two arguments must be Material instances.");this.id=o.idCounter++,this.materialA=e,this.materialB=f,this.friction=void 0!==n.friction?n.friction:.3,this.restitution=void 0!==n.restitution?n.restitution:0,this.stiffness=void 0!==n.stiffness?n.stiffness:i.DEFAULT_STIFFNESS,this.relaxation=void 0!==n.relaxation?n.relaxation:i.DEFAULT_RELAXATION,this.frictionStiffness=void 0!==n.frictionStiffness?n.frictionStiffness:i.DEFAULT_STIFFNESS,this.frictionRelaxation=void 0!==n.frictionRelaxation?n.frictionRelaxation:i.DEFAULT_RELAXATION,this.surfaceVelocity=void 0!==n.surfaceVelocity?n.surfaceVelocity:0,this.contactSkinSize=.005}var d=e("./Material"),i=e("../equations/Equation");f.exports=o,o.idCounter=0},{"../equations/Equation":21,"./Material":27}],27:[function(e,f,n){function o(){this.id=o.idCounter++}f.exports=o,o.idCounter=0},{}],28:[function(e,f,n){var o={};o.GetArea=function(e){if(e.length<6)return 0;for(var f=e.length-2,n=0,o=0;f>o;o+=2)n+=(e[o+2]-e[o])*(e[o+1]+e[o+3]);return n+=(e[0]-e[f])*(e[f+1]+e[1]),.5*-n},o.Triangulate=function(e){var f=e.length>>1;if(3>f)return[];for(var n=[],d=[],i=0;f>i;i++)d.push(i);for(var i=0,t=f;t>3;){var l=d[(i+0)%t],p=d[(i+1)%t],u=d[(i+2)%t],s=e[2*l],c=e[2*l+1],y=e[2*p],a=e[2*p+1],r=e[2*u],w=e[2*u+1],b=!1;if(o._convex(s,c,y,a,r,w)){b=!0;for(var g=0;t>g;g++){var m=d[g];if(m!=l&&m!=p&&m!=u&&o._PointInTriangle(e[2*m],e[2*m+1],s,c,y,a,r,w)){b=!1;break}}}if(b)n.push(l,p,u),d.splice((i+1)%t,1),t--,i=0;else if(i++>3*t)break}return n.push(d[0],d[1],d[2]),n},o._PointInTriangle=function(e,f,n,o,d,i,t,l){var p=t-n,u=l-o,s=d-n,c=i-o,y=e-n,a=f-o,r=p*p+u*u,w=p*s+u*c,b=p*y+u*a,g=s*s+c*c,m=s*y+c*a,x=1/(r*g-w*w),j=(g*b-w*m)*x,v=(r*m-w*b)*x;return j>=0&&v>=0&&1>j+v},o._convex=function(e,f,n,o,d,i){return(f-o)*(d-n)+(n-e)*(i-o)>=0},f.exports=o},{}],29:[function(e,f,n){var o=f.exports={},d=e("../utils/Utils");o.crossLength=function(e,f){return e[0]*f[1]-e[1]*f[0]},o.crossVZ=function(e,f,n){return o.rotate(e,f,-Math.PI/2),o.scale(e,e,n),e},o.crossZV=function(e,f,n){return o.rotate(e,n,Math.PI/2),o.scale(e,e,f),e},o.rotate=function(e,f,n){if(0!==n){var o=Math.cos(n),d=Math.sin(n),i=f[0],t=f[1];e[0]=o*i-d*t,e[1]=d*i+o*t}else e[0]=f[0],e[1]=f[1]},o.rotate90cw=function(e,f){var n=f[0],o=f[1];e[0]=o,e[1]=-n},o.toLocalFrame=function(e,f,n,o){var d=Math.cos(-o),i=Math.sin(-o),t=f[0]-n[0],l=f[1]-n[1];e[0]=d*t-i*l,e[1]=i*t+d*l},o.toGlobalFrame=function(e,f,n,o){var d=Math.cos(o),i=Math.sin(o),t=f[0],l=f[1],p=n[0],u=n[1];e[0]=d*t-i*l+p,e[1]=i*t+d*l+u},o.vectorToLocalFrame=function(e,f,n){var o=Math.cos(-n),d=Math.sin(-n),i=f[0],t=f[1];e[0]=o*i-d*t,e[1]=d*i+o*t},o.vectorToGlobalFrame=o.rotate,o.centroid=function(e,f,n,d){return o.add(e,f,n),o.add(e,e,d),o.scale(e,e,1/3),e},o.create=function(){var e=new d.ARRAY_TYPE(2);return e[0]=0,e[1]=0,e},o.clone=function(e){var f=new d.ARRAY_TYPE(2);return f[0]=e[0],f[1]=e[1],f},o.fromValues=function(e,f){var n=new d.ARRAY_TYPE(2);return n[0]=e,n[1]=f,n},o.copy=function(e,f){return e[0]=f[0],e[1]=f[1],e},o.set=function(e,f,n){return e[0]=f,e[1]=n,e},o.add=function(e,f,n){return e[0]=f[0]+n[0],e[1]=f[1]+n[1],e},o.subtract=function(e,f,n){return e[0]=f[0]-n[0],e[1]=f[1]-n[1],e},o.sub=o.subtract,o.multiply=function(e,f,n){return e[0]=f[0]*n[0],e[1]=f[1]*n[1],e},o.mul=o.multiply,o.divide=function(e,f,n){return e[0]=f[0]/n[0],e[1]=f[1]/n[1],e},o.div=o.divide,o.scale=function(e,f,n){return e[0]=f[0]*n,e[1]=f[1]*n,e},o.distance=function(e,f){var n=f[0]-e[0],o=f[1]-e[1];return Math.sqrt(n*n+o*o)},o.dist=o.distance,o.squaredDistance=function(e,f){var n=f[0]-e[0],o=f[1]-e[1];return n*n+o*o},o.sqrDist=o.squaredDistance,o.length=function(e){var f=e[0],n=e[1];return Math.sqrt(f*f+n*n)},o.len=o.length,o.squaredLength=function(e){var f=e[0],n=e[1];return f*f+n*n},o.sqrLen=o.squaredLength,o.negate=function(e,f){return e[0]=-f[0],e[1]=-f[1],e},o.normalize=function(e,f){var n=f[0],o=f[1],d=n*n+o*o;return d>0&&(d=1/Math.sqrt(d),e[0]=f[0]*d,e[1]=f[1]*d),e},o.dot=function(e,f){return e[0]*f[0]+e[1]*f[1]},o.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},o.lerp=function(e,f,n,o){var d=f[0],i=f[1];return e[0]=d+o*(n[0]-d),e[1]=i+o*(n[1]-i),e},o.reflect=function(e,f,n){var o=f[0]*n[0]+f[1]*n[1];e[0]=f[0]-2*n[0]*o,e[1]=f[1]-2*n[1]*o},o.getLineSegmentsIntersection=function(e,f,n,d,i){var t=o.getLineSegmentsIntersectionFraction(f,n,d,i);return 0>t?!1:(e[0]=f[0]+t*(n[0]-f[0]),e[1]=f[1]+t*(n[1]-f[1]),!0)},o.getLineSegmentsIntersectionFraction=function(e,f,n,o){var d,i,t=f[0]-e[0],l=f[1]-e[1],p=o[0]-n[0],u=o[1]-n[1];return d=(-l*(e[0]-n[0])+t*(e[1]-n[1]))/(-p*l+t*u),i=(p*(e[1]-n[1])-u*(e[0]-n[0]))/(-p*l+t*u),d>=0&&1>=d&&i>=0&&1>=i?i:-1}},{"../utils/Utils":56}],30:[function(e,f,n){function o(e){e=e||{},a.call(this),this.id=e.id||++o._idCounter,this.world=null,this.shapes=[],this.mass=e.mass||0,this.invMass=0,this.inertia=0,this.invInertia=0,this.invMassSolve=0,this.invInertiaSolve=0,this.fixedRotation=!!e.fixedRotation,this.fixedX=!!e.fixedX,this.fixedY=!!e.fixedY,this.massMultiplier=l(),this.position=e.position?d.clone(e.position):l(),this.interpolatedPosition=d.clone(this.position),this.previousPosition=d.clone(this.position),this.velocity=e.velocity?d.clone(e.velocity):l(),this.vlambda=l(),this.wlambda=0,this.angle=e.angle||0,this.previousAngle=this.angle,this.interpolatedAngle=this.angle,this.angularVelocity=e.angularVelocity||0,this.force=e.force?d.clone(e.force):l(),this.angularForce=e.angularForce||0,this.damping=void 0!==e.damping?e.damping:.1,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.1,this.type=o.STATIC,void 0!==e.type?this.type=e.type:e.mass?this.type=o.DYNAMIC:this.type=o.STATIC,this.boundingRadius=0,this.aabb=new y,this.aabbNeedsUpdate=!0,this.allowSleep=void 0!==e.allowSleep?e.allowSleep:!0,this.wantsToSleep=!1,this.sleepState=o.AWAKE,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.2,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.gravityScale=void 0!==e.gravityScale?e.gravityScale:1,this.collisionResponse=void 0!==e.collisionResponse?e.collisionResponse:!0,this.idleTime=0,this.timeLastSleepy=0,this.ccdSpeedThreshold=void 0!==e.ccdSpeedThreshold?e.ccdSpeedThreshold:-1,this.ccdIterations=void 0!==e.ccdIterations?e.ccdIterations:10,this.concavePath=null,this._wakeUpAfterNarrowphase=!1,this.updateMassProperties()}var d=e("../math/vec2"),i=d.add,t=d.sub,l=d.create,p=e("poly-decomp"),u=e("../shapes/Convex"),s=e("../collision/RaycastResult"),c=e("../collision/Ray"),y=e("../collision/AABB"),a=e("../events/EventEmitter");f.exports=o,o.prototype=new a,o.prototype.constructor=o,o._idCounter=0;var r={type:"sleepy"},w={type:"sleep"},b={type:"wakeup"};o.prototype.updateSolveMassProperties=function(){this.sleepState===o.SLEEPING||this.type===o.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve=0):(this.invMassSolve=this.invMass,this.invInertiaSolve=this.invInertia)},o.prototype.setDensity=function(e){var f=this.getArea();this.mass=f*e,this.updateMassProperties()},o.prototype.getArea=function(){for(var e=0,f=0;f<this.shapes.length;f++)e+=this.shapes[f].area;return e},o.prototype.getAABB=function(){return this.aabbNeedsUpdate&&this.updateAABB(),this.aabb};var g=new y,m=l();o.prototype.updateAABB=function(){for(var e=this.shapes,f=e.length,n=m,o=this.angle,i=0;i!==f;i++){var t=e[i],l=t.angle+o;d.toGlobalFrame(n,t.position,this.position,o),t.computeAABB(g,n,l),0===i?this.aabb.copy(g):this.aabb.extend(g)}this.aabbNeedsUpdate=!1},o.prototype.updateBoundingRadius=function(){for(var e=this.shapes,f=e.length,n=0,o=0;o!==f;o++){var i=e[o],t=d.length(i.position),l=i.boundingRadius;t+l>n&&(n=t+l)}this.boundingRadius=n},o.prototype.addShape=function(e,f,n){if(e.body)throw new Error("A shape can only be added to one body.");var o=this.world;if(o&&o.stepping)throw new Error("A shape cannot be added during step.");e.body=this,f?d.copy(e.position,f):d.set(e.position,0,0),e.angle=n||0,this.shapes.push(e),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0},o.prototype.removeShape=function(e){var f=this.world;if(f&&f.stepping)throw new Error("A shape cannot be removed during step.");var n=this.shapes.indexOf(e);return-1!==n?(this.shapes.splice(n,1),this.aabbNeedsUpdate=!0,e.body=null,!0):!1},o.prototype.updateMassProperties=function(){if(this.type===o.STATIC||this.type===o.KINEMATIC)this.mass=Number.MAX_VALUE,this.invMass=0,this.inertia=Number.MAX_VALUE,this.invInertia=0;else{var e=this.shapes,f=e.length,n=this.mass/f,i=0;if(this.fixedRotation)this.inertia=Number.MAX_VALUE,this.invInertia=0;else{for(var t=0;f>t;t++){var l=e[t],p=d.squaredLength(l.position),u=l.computeMomentOfInertia(n);i+=u+n*p}this.inertia=i,this.invInertia=i>0?1/i:0}this.invMass=1/this.mass,d.set(this.massMultiplier,this.fixedX?0:1,this.fixedY?0:1)}},o.prototype.applyForce=function(e,f){if(i(this.force,this.force,e),f){var n=d.crossLength(f,e);this.angularForce+=n}};var x=l(),j=l(),v=l();o.prototype.applyForceLocal=function(e,f){f=f||v;var n=x,o=j;this.vectorToWorldFrame(n,e),this.vectorToWorldFrame(o,f),this.applyForce(n,o)};var h=l();o.prototype.applyImpulse=function(e,f){if(this.type===o.DYNAMIC){var n=h;if(d.scale(n,e,this.invMass),d.multiply(n,this.massMultiplier,n),i(this.velocity,n,this.velocity),f){var t=d.crossLength(f,e);t*=this.invInertia,this.angularVelocity+=t}}};var k=l(),q=l(),z=l();o.prototype.applyImpulseLocal=function(e,f){f=f||z;var n=k,o=q;this.vectorToWorldFrame(n,e),this.vectorToWorldFrame(o,f),this.applyImpulse(n,o)},o.prototype.toLocalFrame=function(e,f){d.toLocalFrame(e,f,this.position,this.angle)},o.prototype.toWorldFrame=function(e,f){d.toGlobalFrame(e,f,this.position,this.angle);
},o.prototype.vectorToLocalFrame=function(e,f){d.vectorToLocalFrame(e,f,this.angle)},o.prototype.vectorToWorldFrame=function(e,f){d.vectorToGlobalFrame(e,f,this.angle)},o.prototype.fromPolygon=function(e,f){f=f||{};for(var n=this.shapes.length;n>=0;--n)this.removeShape(this.shapes[n]);var o=new p.Polygon;o.vertices=e.slice(0);for(var n=0;n<o.vertices.length;n++)o.vertices[n]=d.clone(o.vertices[n]);if(o.makeCCW(),void 0!==f.removeCollinearPoints&&o.removeCollinearPoints(f.removeCollinearPoints),f.skipSimpleCheck&&!o.isSimple())return!1;for(var i=this.concavePath=o.vertices.slice(0),n=0;n<i.length;n++)i[n]=d.clone(i[n]);var s;s=f.optimalDecomp?o.decomp():o.quickDecomp();for(var c=l(),n=0;n!==s.length;n++){for(var y=new u({vertices:s[n].vertices}),a=0;a!==y.vertices.length;a++){var r=y.vertices[a];t(r,r,y.centerOfMass)}d.scale(c,y.centerOfMass,1),y.updateTriangles(),y.updateCenterOfMass(),y.updateBoundingRadius(),this.addShape(y,c)}return this.adjustCenterOfMass(),this.aabbNeedsUpdate=!0,!0};var A=l(),B=l(),C=l();o.prototype.adjustCenterOfMass=function(){var e=A,f=B,n=C,o=0;d.set(f,0,0);for(var l=0;l!==this.shapes.length;l++){var p=this.shapes[l];d.scale(e,p.position,p.area),i(f,f,e),o+=p.area}d.scale(n,f,1/o);for(var l=0;l!==this.shapes.length;l++){var p=this.shapes[l];t(p.position,p.position,n)}i(this.position,this.position,n);for(var l=0;this.concavePath&&l<this.concavePath.length;l++)t(this.concavePath[l],this.concavePath[l],n);this.updateMassProperties(),this.updateBoundingRadius()},o.prototype.setZeroForce=function(){d.set(this.force,0,0),this.angularForce=0},o.prototype.resetConstraintVelocity=function(){var e=this,f=e.vlambda;d.set(f,0,0),e.wlambda=0},o.prototype.addConstraintVelocity=function(){var e=this,f=e.velocity;i(f,f,e.vlambda),e.angularVelocity+=e.wlambda},o.prototype.applyDamping=function(e){if(this.type===o.DYNAMIC){var f=this.velocity;d.scale(f,f,Math.pow(1-this.damping,e)),this.angularVelocity*=Math.pow(1-this.angularDamping,e)}},o.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=o.AWAKE,this.idleTime=0,e!==o.AWAKE&&this.emit(b)},o.prototype.sleep=function(){this.sleepState=o.SLEEPING,this.angularVelocity=this.angularForce=0,d.set(this.velocity,0,0),d.set(this.force,0,0),this.emit(w)},o.prototype.sleepTick=function(e,f,n){if(this.allowSleep&&this.type!==o.SLEEPING){this.wantsToSleep=!1;var i=d.squaredLength(this.velocity)+Math.pow(this.angularVelocity,2),t=Math.pow(this.sleepSpeedLimit,2);i>=t?(this.idleTime=0,this.sleepState=o.AWAKE):(this.idleTime+=n,this.sleepState!==o.SLEEPY&&(this.sleepState=o.SLEEPY,this.emit(r))),this.idleTime>this.sleepTimeLimit&&(f?this.wantsToSleep=!0:this.sleep())}},o.prototype.overlaps=function(e){return this.world.overlapKeeper.bodiesAreOverlapping(this,e)};var D=l(),E=l();o.prototype.integrate=function(e){var f=this.invMass,n=this.force,o=this.position,t=this.velocity;d.copy(this.previousPosition,this.position),this.previousAngle=this.angle,this.fixedRotation||(this.angularVelocity+=this.angularForce*this.invInertia*e),d.scale(D,n,e*f),d.multiply(D,this.massMultiplier,D),i(t,D,t),this.integrateToTimeOfImpact(e)||(d.scale(E,t,e),i(o,o,E),this.fixedRotation||(this.angle+=this.angularVelocity*e)),this.aabbNeedsUpdate=!0};var F=new s,G=new c({mode:c.CLOSEST,skipBackfaces:!0}),H=l(),I=l(),J=l(),K=l();o.prototype.integrateToTimeOfImpact=function(e){if(this.ccdSpeedThreshold<0||d.squaredLength(this.velocity)<Math.pow(this.ccdSpeedThreshold,2))return!1;for(var f=[],n=this.world.disabledBodyCollisionPairs,o=0;o<n.length;o+=2){var l=n[o],p=n[o+1];l===this?f.push(p):p===this&&f.push(l)}d.normalize(H,this.velocity),d.scale(I,this.velocity,e),i(I,I,this.position),t(J,I,this.position);var u,s=this.angularVelocity*e,c=d.length(J),y=1;d.copy(G.from,this.position),d.copy(G.to,I),G.update();for(var o=0;o<this.shapes.length;o++){var a=this.shapes[o];if(F.reset(),G.collisionGroup=a.collisionGroup,G.collisionMask=a.collisionMask,this.world.raycast(F,G),u=F.body,(u===this||-1!==f.indexOf(u))&&(u=null),u)break}if(!u||!y)return!1;F.getHitPoint(I,G),t(J,I,this.position),y=d.distance(I,this.position)/c;var r=this.angle;d.copy(K,this.position);for(var w=0,b=0,g=y,m=1;m>=b&&w<this.ccdIterations;){w++,g=(m+b)/2,d.scale(E,J,g),i(this.position,K,E),this.angle=r+s*g,this.updateAABB();var x=this.aabb.overlaps(u.aabb)&&this.world.narrowphase.bodiesOverlap(this,u,!0);x?m=g:b=g}return y=m,d.copy(this.position,K),this.angle=r,d.scale(E,J,y),i(this.position,this.position,E),this.fixedRotation||(this.angle+=s*y),!0},o.prototype.getVelocityAtPoint=function(e,f){return d.crossVZ(e,f,this.angularVelocity),d.subtract(e,this.velocity,e),e},o.DYNAMIC=1,o.STATIC=2,o.KINEMATIC=4,o.AWAKE=0,o.SLEEPY=1,o.SLEEPING=2},{"../collision/AABB":6,"../collision/Ray":10,"../collision/RaycastResult":11,"../events/EventEmitter":25,"../math/vec2":29,"../shapes/Convex":39,"poly-decomp":5}],31:[function(e,f,n){function o(e,f,n){n=n||{},i.call(this,e,f,n),this.localAnchorA=d.create(),this.localAnchorB=d.create(),n.localAnchorA&&d.copy(this.localAnchorA,n.localAnchorA),n.localAnchorB&&d.copy(this.localAnchorB,n.localAnchorB),n.worldAnchorA&&this.setWorldAnchorA(n.worldAnchorA),n.worldAnchorB&&this.setWorldAnchorB(n.worldAnchorB);var o=d.create(),t=d.create();this.getWorldAnchorA(o),this.getWorldAnchorB(t);var l=d.distance(o,t);this.restLength=void 0!==n.restLength?n.restLength:l}var d=e("../math/vec2"),i=e("./Spring");f.exports=o,o.prototype=new i,o.prototype.constructor=o,o.prototype.setWorldAnchorA=function(e){this.bodyA.toLocalFrame(this.localAnchorA,e)},o.prototype.setWorldAnchorB=function(e){this.bodyB.toLocalFrame(this.localAnchorB,e)},o.prototype.getWorldAnchorA=function(e){this.bodyA.toWorldFrame(e,this.localAnchorA)},o.prototype.getWorldAnchorB=function(e){this.bodyB.toWorldFrame(e,this.localAnchorB)};var t=d.create(),l=d.create(),p=d.create(),u=d.create(),s=d.create(),c=d.create(),y=d.create(),a=d.create(),r=d.create();o.prototype.applyForce=function(){var e=this.stiffness,f=this.damping,n=this.restLength,o=this.bodyA,i=this.bodyB,w=t,b=l,g=p,m=u,x=r,j=s,v=c,h=y,k=a;this.getWorldAnchorA(j),this.getWorldAnchorB(v),d.sub(h,j,o.position),d.sub(k,v,i.position),d.sub(w,v,j);var q=d.len(w);d.normalize(b,w),d.sub(g,i.velocity,o.velocity),d.crossZV(x,i.angularVelocity,k),d.add(g,g,x),d.crossZV(x,o.angularVelocity,h),d.sub(g,g,x),d.scale(m,b,-e*(q-n)-f*d.dot(g,b)),d.sub(o.force,o.force,m),d.add(i.force,i.force,m);var z=d.crossLength(h,m),A=d.crossLength(k,m);o.angularForce-=z,i.angularForce+=A}},{"../math/vec2":29,"./Spring":33}],32:[function(e,f,n){function o(e,f,n){n=n||{},d.call(this,e,f,n),this.restAngle=void 0!==n.restAngle?n.restAngle:f.angle-e.angle}var d=e("./Spring");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.applyForce=function(){var e=this.stiffness,f=this.damping,n=this.restAngle,o=this.bodyA,d=this.bodyB,i=d.angle-o.angle,t=d.angularVelocity-o.angularVelocity,l=-e*(i-n)-f*t*0;o.angularForce-=l,d.angularForce+=l}},{"./Spring":33}],33:[function(e,f,n){function o(e,f,n){n=n||{},this.stiffness=void 0!==n.stiffness?n.stiffness:100,this.damping=void 0!==n.damping?n.damping:1,this.bodyA=e,this.bodyB=f}f.exports=o,o.prototype.applyForce=function(){}},{}],34:[function(e,f,n){function o(e,f){f=f||{},this.chassisBody=e,this.wheels=[],this.groundBody=new p({mass:0}),this.world=null;var n=this;this.preStepCallback=function(){n.update()}}function d(e,f){f=f||{},this.vehicle=e,this.forwardEquation=new l(e.chassisBody,e.groundBody),this.sideEquation=new l(e.chassisBody,e.groundBody),this.steerValue=0,this.engineForce=0,this.setSideFriction(void 0!==f.sideFriction?f.sideFriction:5),this.localForwardVector=i.fromValues(0,1),f.localForwardVector&&i.copy(this.localForwardVector,f.localForwardVector),this.localPosition=i.create(),f.localPosition&&i.copy(this.localPosition,f.localPosition),t.call(this,e.chassisBody,e.groundBody),this.equations.push(this.forwardEquation,this.sideEquation),this.setBrakeForce(0)}var i=e("../math/vec2"),t=e("../constraints/Constraint"),l=e("../equations/FrictionEquation"),p=e("../objects/Body");f.exports=o,o.prototype.addToWorld=function(e){this.world=e,e.addBody(this.groundBody),e.on("preStep",this.preStepCallback);for(var f=0;f<this.wheels.length;f++){var n=this.wheels[f];e.addConstraint(n)}},o.prototype.removeFromWorld=function(){var e=this.world;e.removeBody(this.groundBody),e.off("preStep",this.preStepCallback);for(var f=0;f<this.wheels.length;f++){var n=this.wheels[f];e.removeConstraint(n)}this.world=null},o.prototype.addWheel=function(e){var f=new d(this,e);return this.wheels.push(f),f},o.prototype.update=function(){for(var e=0;e<this.wheels.length;e++)this.wheels[e].update()},d.prototype=new t,d.prototype.setBrakeForce=function(e){this.forwardEquation.setSlipForce(e)},d.prototype.setSideFriction=function(e){this.sideEquation.setSlipForce(e)};var u=i.create(),s=i.create();d.prototype.getSpeed=function(){var e=this.vehicle.chassisBody;return e.vectorToWorldFrame(s,this.localForwardVector),e.getVelocityAtPoint(u,s),i.dot(u,s)};var c=i.create();d.prototype.update=function(){var e=this.vehicle.chassisBody,f=this.forwardEquation,n=this.sideEquation,o=this.steerValue;e.vectorToWorldFrame(f.t,this.localForwardVector),i.rotate(n.t,this.localForwardVector,Math.PI/2),e.vectorToWorldFrame(n.t,n.t),i.rotate(f.t,f.t,o),i.rotate(n.t,n.t,o),e.toWorldFrame(f.contactPointB,this.localPosition),i.copy(n.contactPointB,f.contactPointB),e.vectorToWorldFrame(f.contactPointA,this.localPosition),i.copy(n.contactPointA,f.contactPointA),i.normalize(c,f.t),i.scale(c,c,this.engineForce),this.vehicle.chassisBody.applyForce(c,f.contactPointA)}},{"../constraints/Constraint":13,"../equations/FrictionEquation":22,"../math/vec2":29,"../objects/Body":30}],35:[function(e,f,n){var o=f.exports={AABB:e("./collision/AABB"),AngleLockEquation:e("./equations/AngleLockEquation"),Body:e("./objects/Body"),Broadphase:e("./collision/Broadphase"),Capsule:e("./shapes/Capsule"),Circle:e("./shapes/Circle"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),ContactEquationPool:e("./utils/ContactEquationPool"),ContactMaterial:e("./material/ContactMaterial"),Convex:e("./shapes/Convex"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventEmitter:e("./events/EventEmitter"),FrictionEquation:e("./equations/FrictionEquation"),FrictionEquationPool:e("./utils/FrictionEquationPool"),GearConstraint:e("./constraints/GearConstraint"),GSSolver:e("./solver/GSSolver"),Heightfield:e("./shapes/Heightfield"),Line:e("./shapes/Line"),LockConstraint:e("./constraints/LockConstraint"),Material:e("./material/Material"),Narrowphase:e("./collision/Narrowphase"),NaiveBroadphase:e("./collision/NaiveBroadphase"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),Pool:e("./utils/Pool"),RevoluteConstraint:e("./constraints/RevoluteConstraint"),PrismaticConstraint:e("./constraints/PrismaticConstraint"),Ray:e("./collision/Ray"),RaycastResult:e("./collision/RaycastResult"),Box:e("./shapes/Box"),RotationalVelocityEquation:e("./equations/RotationalVelocityEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Spring:e("./objects/Spring"),TopDownVehicle:e("./objects/TopDownVehicle"),LinearSpring:e("./objects/LinearSpring"),RotationalSpring:e("./objects/RotationalSpring"),Utils:e("./utils/Utils"),World:e("./world/World"),vec2:e("./math/vec2"),version:"0.7.1-tvo"};Object.defineProperty(o,"Rectangle",{get:function(){return console.warn("The Rectangle class has been renamed to Box."),this.Box}})},{"./collision/AABB":6,"./collision/Broadphase":7,"./collision/NaiveBroadphase":8,"./collision/Narrowphase":9,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/GearConstraint":15,"./constraints/LockConstraint":16,"./constraints/PrismaticConstraint":17,"./constraints/RevoluteConstraint":18,"./equations/AngleLockEquation":19,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalVelocityEquation":24,"./events/EventEmitter":25,"./material/ContactMaterial":26,"./material/Material":27,"./math/vec2":29,"./objects/Body":30,"./objects/LinearSpring":31,"./objects/RotationalSpring":32,"./objects/Spring":33,"./objects/TopDownVehicle":34,"./shapes/Box":36,"./shapes/Capsule":37,"./shapes/Circle":38,"./shapes/Convex":39,"./shapes/Heightfield":40,"./shapes/Line":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./solver/GSSolver":45,"./solver/Solver":46,"./utils/ContactEquationPool":47,"./utils/FrictionEquationPool":48,"./utils/Pool":54,"./utils/Utils":56,"./world/World":60}],36:[function(e,f,n){function o(e){"number"==typeof arguments[0]&&"number"==typeof arguments[1]&&(e={width:arguments[0],height:arguments[1]},console.warn("The Rectangle has been renamed to Box and its constructor signature has changed. Please use the following format: new Box({ width: 1, height: 1, ... })")),e=e||{};var f=this.width=e.width||1,n=this.height=e.height||1,o=[d.fromValues(-f/2,-n/2),d.fromValues(f/2,-n/2),d.fromValues(f/2,n/2),d.fromValues(-f/2,n/2)],p=[d.fromValues(1,0),d.fromValues(0,1)],u=t(e);u.vertices=o,u.axes=p,u.type=i.BOX,l.call(this,u)}var d=e("../math/vec2"),i=e("./Shape"),t=e("../utils/Utils").shallowClone,l=e("./Convex");f.exports=o,o.prototype=new l,o.prototype.constructor=o,o.prototype.computeMomentOfInertia=function(e){var f=this.width,n=this.height;return e*(n*n+f*f)/12},o.prototype.updateBoundingRadius=function(){var e=this.width,f=this.height;this.boundingRadius=Math.sqrt(e*e+f*f)/2},o.prototype.computeAABB=function(e,f,n){var o=Math.abs(Math.cos(n)),d=Math.abs(Math.sin(n)),i=this.width,t=this.height,l=.5*(i*d+t*o),p=.5*(t*d+i*o),u=e.lowerBound,s=e.upperBound,c=f[0],y=f[1];u[0]=c-p,u[1]=y-l,s[0]=c+p,s[1]=y+l},o.prototype.updateArea=function(){this.area=this.width*this.height}},{"../math/vec2":29,"../utils/Utils":56,"./Convex":39,"./Shape":44}],37:[function(e,f,n){function o(e){"number"==typeof arguments[0]&&"number"==typeof arguments[1]&&(e={length:arguments[0],radius:arguments[1]},console.warn("The Capsule constructor signature has changed. Please use the following format: new Capsule({ radius: 1, length: 1 })")),e=e?i(e):{},this.length=e.length||1,this.radius=e.radius||1,e.type=d.CAPSULE,d.call(this,e)}var d=e("./Shape"),i=e("../utils/Utils").shallowClone,t=e("../math/vec2");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.computeMomentOfInertia=function(e){var f=this.radius,n=this.length+f,o=2*f;return e*(o*o+n*n)/12},o.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius+this.length/2},o.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius+2*this.radius*this.length};var l=t.create();o.prototype.computeAABB=function(e,f,n){var o=this.radius;t.set(l,this.length/2,0),0!==n&&t.rotate(l,l,n),t.set(e.upperBound,Math.max(l[0]+o,-l[0]+o),Math.max(l[1]+o,-l[1]+o)),t.set(e.lowerBound,Math.min(l[0]-o,-l[0]-o),Math.min(l[1]-o,-l[1]-o)),t.add(e.lowerBound,e.lowerBound,f),t.add(e.upperBound,e.upperBound,f)};var p=t.create(),u=t.create(),s=t.create(),c=t.create(),y=t.fromValues(0,1);o.prototype.raycast=function(e,f,n,o){for(var d=f.from,i=f.to,l=p,a=u,r=s,w=c,b=this.length/2,g=0;2>g;g++){var m=this.radius*(2*g-1);t.set(r,-b,m),t.set(w,b,m),t.toGlobalFrame(r,r,n,o),t.toGlobalFrame(w,w,n,o);var x=t.getLineSegmentsIntersectionFraction(d,i,r,w);if(x>=0&&(t.rotate(a,y,o),t.scale(a,a,2*g-1),f.reportIntersection(e,x,a,-1),e.shouldStop(f)))return}for(var j=Math.pow(this.radius,2)+Math.pow(b,2),g=0;2>g;g++){t.set(r,b*(2*g-1),0),t.toGlobalFrame(r,r,n,o);var v=Math.pow(i[0]-d[0],2)+Math.pow(i[1]-d[1],2),h=2*((i[0]-d[0])*(d[0]-r[0])+(i[1]-d[1])*(d[1]-r[1])),k=Math.pow(d[0]-r[0],2)+Math.pow(d[1]-r[1],2)-Math.pow(this.radius,2),x=Math.pow(h,2)-4*v*k;if(!(0>x))if(0===x){if(t.lerp(l,d,i,x),t.squaredDistance(l,n)>j&&(t.sub(a,l,r),t.normalize(a,a),f.reportIntersection(e,x,a,-1),e.shouldStop(f)))return}else{var q=Math.sqrt(x),z=1/(2*v),A=(-h-q)*z,B=(-h+q)*z;if(A>=0&&1>=A&&(t.lerp(l,d,i,A),t.squaredDistance(l,n)>j&&(t.sub(a,l,r),t.normalize(a,a),f.reportIntersection(e,A,a,-1),e.shouldStop(f))))return;if(B>=0&&1>=B&&(t.lerp(l,d,i,B),t.squaredDistance(l,n)>j&&(t.sub(a,l,r),t.normalize(a,a),f.reportIntersection(e,B,a,-1),e.shouldStop(f))))return}}}},{"../math/vec2":29,"../utils/Utils":56,"./Shape":44}],38:[function(e,f,n){function o(e){"number"==typeof arguments[0]&&(e={radius:arguments[0]},console.warn("The Circle constructor signature has changed. Please use the following format: new Circle({ radius: 1 })")),e=e?t(e):{},this.radius=e.radius||1,e.type=d.CIRCLE,d.call(this,e)}var d=e("./Shape"),i=e("../math/vec2"),t=e("../utils/Utils").shallowClone;f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.computeMomentOfInertia=function(e){var f=this.radius;return e*f*f/2},o.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius},o.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius},o.prototype.computeAABB=function(e,f){var n=this.radius;i.set(e.upperBound,n,n),i.set(e.lowerBound,-n,-n),f&&(i.add(e.lowerBound,e.lowerBound,f),i.add(e.upperBound,e.upperBound,f))};var l=i.create(),p=i.create();o.prototype.raycast=function(e,f,n){var o=f.from,d=f.to,t=this.radius,u=Math.pow(d[0]-o[0],2)+Math.pow(d[1]-o[1],2),s=2*((d[0]-o[0])*(o[0]-n[0])+(d[1]-o[1])*(o[1]-n[1])),c=Math.pow(o[0]-n[0],2)+Math.pow(o[1]-n[1],2)-Math.pow(t,2),y=Math.pow(s,2)-4*u*c,a=l,r=p;if(!(0>y))if(0===y)i.lerp(a,o,d,y),i.sub(r,a,n),i.normalize(r,r),f.reportIntersection(e,y,r,-1);else{var w=Math.sqrt(y),b=1/(2*u),g=(-s-w)*b,m=(-s+w)*b;if(g>=0&&1>=g&&(i.lerp(a,o,d,g),i.sub(r,a,n),i.normalize(r,r),f.reportIntersection(e,g,r,-1),e.shouldStop(f)))return;m>=0&&1>=m&&(i.lerp(a,o,d,m),i.sub(r,a,n),i.normalize(r,r),f.reportIntersection(e,m,r,-1))}}},{"../math/vec2":29,"../utils/Utils":56,"./Shape":44}],39:[function(e,f,n){function o(e){Array.isArray(arguments[0])&&(e={vertices:arguments[0],axes:arguments[1]},console.warn("The Convex constructor signature has changed. Please use the following format: new Convex({ vertices: [...], ... })")),e=e?u(e):{},this.vertices=[];for(var f=void 0!==e.vertices?e.vertices:[],n=0;n<f.length;n++)this.vertices.push(t.clone(f[n]));for(var o=this.normals=[],n=0;n<f.length;n++)o.push(t.create());if(this.updateNormals(),this.axes=[],e.axes)for(var n=0;n<e.axes.length;n++)this.axes.push(t.clone(e.axes[n]));else for(var n=0;n<this.vertices.length;n++){var d=this.vertices[n],l=this.vertices[(n+1)%this.vertices.length],p=t.create();t.sub(p,l,d),t.rotate90cw(p,p),t.normalize(p,p),this.axes.push(p)}if(this.centerOfMass=t.create(),this.triangles=[],this.vertices.length&&(this.updateTriangles(),this.updateCenterOfMass()),this.boundingRadius=0,e.type=e.type||i.CONVEX,i.call(this,e),this.updateBoundingRadius(),this.updateArea(),this.area<0)throw new Error("Convex vertices must be given in conter-clockwise winding.")}function d(e,f,n){return.5*((f[0]-e[0])*(n[1]-e[1])-(n[0]-e[0])*(f[1]-e[1]))}var i=e("./Shape"),t=e("../math/vec2"),l=t.dot,p=e("../math/polyk"),u=e("../utils/Utils").shallowClone;f.exports=o,o.prototype=new i,o.prototype.constructor=o;var s=t.create(),c=t.create();o.prototype.updateNormals=function(){for(var e=this.vertices,f=this.normals,n=0;n<e.length;n++){var o=e[n],d=e[(n+1)%e.length],i=f[n];t.sub(i,d,o),t.rotate90cw(i,i),t.normalize(i,i)}},o.prototype.projectOntoLocalAxis=function(e,f){for(var n,o,d=null,i=null,e=s,p=0;p<this.vertices.length;p++)n=this.vertices[p],o=l(n,e),(null===d||o>d)&&(d=o),(null===i||i>o)&&(i=o);if(i>d){var u=i;i=d,d=u}t.set(f,i,d)},o.prototype.projectOntoWorldAxis=function(e,f,n,o){var d=c;this.projectOntoLocalAxis(e,o),0!==n?t.rotate(d,e,n):d=e;var i=l(f,d);t.set(o,o[0]+i,o[1]+i)},o.prototype.updateTriangles=function(){this.triangles.length=0;for(var e=[],f=0;f<this.vertices.length;f++){var n=this.vertices[f];e.push(n[0],n[1])}for(var o=p.Triangulate(e),f=0;f<o.length;f+=3){var d=o[f],i=o[f+1],t=o[f+2];this.triangles.push([d,i,t])}};var y=t.create(),a=t.create(),r=t.create(),w=t.create(),b=t.create();o.prototype.updateCenterOfMass=function(){var e=this.triangles,f=this.vertices,n=this.centerOfMass,o=y,i=r,l=w,p=b,u=a;t.set(n,0,0);for(var s=0,c=0;c!==e.length;c++){var g=e[c],i=f[g[0]],l=f[g[1]],p=f[g[2]];t.centroid(o,i,l,p);var m=d(i,l,p);s+=m,t.scale(u,o,m),t.add(n,n,u)}t.scale(n,n,1/s)},o.prototype.computeMomentOfInertia=function(e){for(var f=0,n=0,o=this.vertices.length,d=o-1,i=0;o>i;d=i,i++){var p=this.vertices[d],u=this.vertices[i],s=Math.abs(t.crossLength(p,u)),c=l(u,u)+l(u,p)+l(p,p);f+=s*c,n+=s}return e/6*(f/n)},o.prototype.updateBoundingRadius=function(){for(var e=this.vertices,f=0,n=0;n!==e.length;n++){var o=t.squaredLength(e[n]);o>f&&(f=o)}this.boundingRadius=Math.sqrt(f)},o.triangleArea=d,o.prototype.updateArea=function(){this.updateTriangles(),this.area=0;for(var e=this.triangles,f=this.vertices,n=0;n!==e.length;n++){var o=e[n],i=f[o[0]],t=f[o[1]],l=f[o[2]],p=d(i,t,l);this.area+=p}},o.prototype.computeAABB=function(e,f,n){e.setFromPoints(this.vertices,f,n,0)};var g=t.create(),m=t.create(),x=t.create();o.prototype.raycast=function(e,f,n,o){var d=g,i=m,l=x,p=this.vertices;t.toLocalFrame(d,f.from,n,o),t.toLocalFrame(i,f.to,n,o);for(var u=p.length,s=0;u>s&&!e.shouldStop(f);s++){var c=p[s],y=p[(s+1)%u],a=t.getLineSegmentsIntersectionFraction(d,i,c,y);a>=0&&(t.sub(l,y,c),t.rotate(l,l,-Math.PI/2+o),t.normalize(l,l),f.reportIntersection(e,a,l,s))}}},{"../math/polyk":28,"../math/vec2":29,"../utils/Utils":56,"./Shape":44}],40:[function(e,f,n){function o(e){if(Array.isArray(arguments[0])){if(e={heights:arguments[0]},"object"==typeof arguments[1])for(var f in arguments[1])e[f]=arguments[1][f];console.warn("The Heightfield constructor signature has changed. Please use the following format: new Heightfield({ heights: [...], ... })")}e=e?t(e):{},this.heights=e.heights?e.heights.slice(0):[],this.maxValue=e.maxValue||null,this.minValue=e.minValue||null,this.elementWidth=e.elementWidth||.1,(void 0===e.maxValue||void 0===e.minValue)&&this.updateMaxMinValues(),e.type=d.HEIGHTFIELD,d.call(this,e)}var d=e("./Shape"),i=e("../math/vec2"),t=e("../utils/Utils").shallowClone;f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.updateMaxMinValues=function(){for(var e=this.heights,f=e[0],n=e[0],o=0;o!==e.length;o++){var d=e[o];d>f&&(f=d),n>d&&(n=d)}this.maxValue=f,this.minValue=n},o.prototype.computeMomentOfInertia=function(){return Number.MAX_VALUE},o.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE},o.prototype.updateArea=function(){for(var e=this.heights,f=0,n=0;n<e.length-1;n++)f+=(e[n]+e[n+1])/2*this.elementWidth;this.area=f};var l=[i.create(),i.create(),i.create(),i.create()];o.prototype.computeAABB=function(e,f,n){i.set(l[0],0,this.maxValue),i.set(l[1],this.elementWidth*this.heights.length,this.maxValue),i.set(l[2],this.elementWidth*this.heights.length,this.minValue),i.set(l[3],0,this.minValue),e.setFromPoints(l,f,n)},o.prototype.getLineSegment=function(e,f,n){var o=this.heights,d=this.elementWidth;i.set(e,n*d,o[n]),i.set(f,(n+1)*d,o[n+1])},o.prototype.getSegmentIndex=function(e){return Math.floor(e[0]/this.elementWidth)},o.prototype.getClampedSegmentIndex=function(e){var f=this.getSegmentIndex(e);return f=Math.min(this.heights.length,Math.max(f,0))};var p=i.create(),u=i.create(),s=i.create(),c=i.create(),y=i.create();o.prototype.raycast=function(e,f,n,o){var d=f.from,t=f.to,l=p,a=u,r=s,w=c,b=y;i.toLocalFrame(w,d,n,o),i.toLocalFrame(b,t,n,o);var g=this.getClampedSegmentIndex(w),m=this.getClampedSegmentIndex(b);if(g>m){var x=g;g=m,m=x}for(var j=0;j<this.heights.length-1;j++){this.getLineSegment(a,r,j);var v=i.getLineSegmentsIntersectionFraction(w,b,a,r);if(v>=0&&(i.sub(l,r,a),i.rotate(l,l,o+Math.PI/2),i.normalize(l,l),f.reportIntersection(e,v,l,-1),e.shouldStop(f)))return}}},{"../math/vec2":29,"../utils/Utils":56,"./Shape":44}],41:[function(e,f,n){function o(e){"number"==typeof arguments[0]&&(e={length:arguments[0]},console.warn("The Line constructor signature has changed. Please use the following format: new Line({ length: 1, ... })")),e=e?i(e):{},this.length=e.length||1,e.type=d.LINE,d.call(this,e)}var d=e("./Shape"),i=e("../utils/Utils").shallowClone,t=e("../math/vec2");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.computeMomentOfInertia=function(e){return e*Math.pow(this.length,2)/12},o.prototype.updateBoundingRadius=function(){this.boundingRadius=this.length/2};var l=[t.create(),t.create()];o.prototype.computeAABB=function(e,f,n){var o=this.length/2;t.set(l[0],-o,0),t.set(l[1],o,0),e.setFromPoints(l,f,n,0)};var p=t.create(),u=t.create(),s=t.create(),c=t.fromValues(0,1);o.prototype.raycast=function(e,f,n,o){var d=f.from,i=f.to,l=u,y=s,a=this.length/2;t.set(l,-a,0),t.set(y,a,0),t.toGlobalFrame(l,l,n,o),t.toGlobalFrame(y,y,n,o);var r=t.getLineSegmentsIntersectionFraction(l,y,d,i);if(r>=0){var w=p;t.rotate(w,c,o),f.reportIntersection(e,r,w,-1)}}},{"../math/vec2":29,"../utils/Utils":56,"./Shape":44}],42:[function(e,f,n){function o(e){e=e?i(e):{},e.type=d.PARTICLE,d.call(this,e)}var d=e("./Shape"),i=e("../utils/Utils").shallowClone,t=e("../math/vec2").copy;f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.computeMomentOfInertia=function(){return 0},o.prototype.updateBoundingRadius=function(){this.boundingRadius=0},o.prototype.computeAABB=function(e,f){t(e.lowerBound,f),t(e.upperBound,f)}},{"../math/vec2":29,"../utils/Utils":56,"./Shape":44}],43:[function(e,f,n){function o(e){e=e?t.shallowClone(e):{},e.type=d.PLANE,d.call(this,e)}var d=e("./Shape"),i=e("../math/vec2"),t=e("../utils/Utils");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.computeMomentOfInertia=function(){return 0},o.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE},o.prototype.computeAABB=function(e,f,n){var o=n%(2*Math.PI),d=i.set,t=1e7,l=e.lowerBound,p=e.upperBound;d(l,-t,-t),d(p,t,t),0===o?p[1]=f[1]:o===Math.PI/2?l[0]=f[0]:o===Math.PI?l[1]=f[1]:o===3*Math.PI/2&&(p[0]=f[0])},o.prototype.updateArea=function(){this.area=Number.MAX_VALUE};var l=i.create(),p=i.create(),u=i.create();o.prototype.raycast=function(e,f,n,o){var d=f.from,t=f.to,s=f.direction,c=l,y=p,a=u;i.set(y,0,1),i.rotate(y,y,o),i.sub(a,d,n);var r=i.dot(a,y);i.sub(a,t,n);var w=i.dot(a,y);if(!(r*w>0||i.squaredDistance(d,t)<r*r)){var b=i.dot(y,s);i.sub(c,d,n);var g=-i.dot(y,c)/b/f.length;f.reportIntersection(e,g,y,-1)}}},{"../math/vec2":29,"../utils/Utils":56,"./Shape":44}],44:[function(e,f,n){function o(e){e=e||{},this.body=null,this.position=d.create(),e.position&&d.copy(this.position,e.position),this.angle=e.angle||0,this.type=e.type||0,this.id=o.idCounter++,this.boundingRadius=0,this.collisionGroup=void 0!==e.collisionGroup?e.collisionGroup:1,this.collisionResponse=void 0!==e.collisionResponse?e.collisionResponse:!0,this.collisionMask=void 0!==e.collisionMask?e.collisionMask:1,this.material=e.material||null,this.area=0,this.sensor=void 0!==e.sensor?e.sensor:!1,this.type&&this.updateBoundingRadius(),this.updateArea()}f.exports=o;var d=e("../math/vec2");o.idCounter=0,o.CIRCLE=1,o.PARTICLE=2,o.PLANE=4,o.CONVEX=8,o.LINE=16,o.BOX=32,Object.defineProperty(o,"RECTANGLE",{get:function(){return console.warn("Shape.RECTANGLE is deprecated, use Shape.BOX instead."),o.BOX}}),o.CAPSULE=64,o.HEIGHTFIELD=128,o.prototype={computeMomentOfInertia:function(){},updateBoundingRadius:function(){},updateArea:function(){},computeAABB:function(){},raycast:function(){}}},{"../math/vec2":29}],45:[function(e,f,n){function o(e){t.call(this,e,t.GS),e=e||{},this.iterations=e.iterations||10,this.tolerance=void 0!==e.tolerance?e.tolerance:1e-7,this.frictionIterations=void 0!==e.frictionIterations?0:e.frictionIterations,this.usedIterations=0}function d(e,f){for(var n=e.length;n--;){var o=e[n];o.multiplier=o.lambda*f}}function i(e){var f=e.B,n=e.epsilon,o=e.invC,d=e.lambda,i=e.computeGWlambda(),t=e.maxForceDt,l=e.minForceDt,p=o*(f-i-n*d),u=d+p;return l>u?p=l-d:u>t&&(p=t-d),e.lambda+=p,e.addToWlambda(p),p}var t=e("./Solver"),l=e("../equations/FrictionEquation");f.exports=o,o.prototype=new t,o.prototype.constructor=o,o.prototype.solve=function(e,f){this.sortEquations();var n=0,o=this.iterations,t=this.frictionIterations,p=this.equations,u=p.length,s=Math.pow(this.tolerance*u,2),c=f.bodies,y=c.length;if(this.usedIterations=0,u)for(var a=0;a!==y;a++){var r=c[a];r.updateSolveMassProperties()}for(var a=0;a!==u;a++){var w=p[a];w.lambda=0,(w.timeStep!==e||w.needsUpdate)&&(w.timeStep=e,w.update()),w.B=w.computeB(w.a,w.b,e),w.invC=w.computeInvC(w.epsilon),w.maxForceDt=w.maxForce*e,w.minForceDt=w.minForce*e}var w,b,a,g;if(0!==u){for(a=0;a!==y;a++){var r=c[a];r.resetConstraintVelocity()}if(t){for(n=0;n!==t;n++){for(b=0,g=0;g!==u;g++){w=p[g];var m=i(w,e);b+=Math.abs(m)}if(this.usedIterations++,s>=b*b)break}for(d(p,1/e),g=0;g!==u;g++){var x=p[g];if(x instanceof l){for(var j=0,v=0;v!==x.contactEquations.length;v++)j+=x.contactEquations[v].multiplier;j*=x.frictionCoefficient/x.contactEquations.length,x.maxForce=j,x.minForce=-j,x.maxForceDt=j*e,x.minForceDt=-j*e}}}for(n=0;n!==o;n++){for(b=0,g=0;g!==u;g++){w=p[g];var m=i(w,e);b+=Math.abs(m)}if(this.usedIterations++,s>b*b)break}for(a=0;a!==y;a++)c[a].addConstraintVelocity();d(p,1/e)}}},{"../equations/FrictionEquation":22,"./Solver":46}],46:[function(e,f,n){function o(e,f){e=e||{},d.call(this),this.type=f,this.equations=[],this.equationSortFunction=e.equationSortFunction||!1}var d=e("../events/EventEmitter");f.exports=o,o.prototype=new d,o.prototype.constructor=o,o.prototype.solve=function(){throw new Error("Solver.solve should be implemented by subclasses!")};var i={bodies:[]};o.prototype.solveIsland=function(e,f){this.removeAllEquations(),f.equations.length&&(this.addEquations(f.equations),i.bodies.length=0,f.getBodies(i.bodies),i.bodies.length&&this.solve(e,i))},o.prototype.sortEquations=function(){this.equationSortFunction&&this.equations.sort(this.equationSortFunction)},o.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},o.prototype.addEquations=function(e){for(var f=0,n=e.length;f!==n;f++){var o=e[f];o.enabled&&this.equations.push(o)}},o.prototype.removeEquation=function(e){var f=this.equations.indexOf(e);-1!==f&&this.equations.splice(f,1)},o.prototype.removeAllEquations=function(){this.equations.length=0},o.GS=1,o.ISLAND=2},{"../events/EventEmitter":25}],47:[function(e,f,n){function o(){i.apply(this,arguments)}var d=e("../equations/ContactEquation"),i=e("./Pool");f.exports=o,o.prototype=new i,o.prototype.constructor=o,o.prototype.create=function(){return new d},o.prototype.destroy=function(e){return e.bodyA=e.bodyB=null,this}},{"../equations/ContactEquation":20,"./Pool":54}],48:[function(e,f,n){function o(){i.apply(this,arguments)}var d=e("../equations/FrictionEquation"),i=e("./Pool");f.exports=o,o.prototype=new i,o.prototype.constructor=o,o.prototype.create=function(){return new d},o.prototype.destroy=function(e){return e.bodyA=e.bodyB=null,this}},{"../equations/FrictionEquation":22,"./Pool":54}],49:[function(e,f,n){function o(){i.apply(this,arguments)}var d=e("../world/IslandNode"),i=e("./Pool");f.exports=o,o.prototype=new i,o.prototype.constructor=o,o.prototype.create=function(){return new d},o.prototype.destroy=function(e){return e.reset(),this}},{"../world/IslandNode":59,"./Pool":54}],50:[function(e,f,n){function o(){i.apply(this,arguments)}var d=e("../world/Island"),i=e("./Pool");f.exports=o,o.prototype=new i,o.prototype.constructor=o,o.prototype.create=function(){return new d},o.prototype.destroy=function(e){return e.reset(),this}},{"../world/Island":57,"./Pool":54}],51:[function(e,f,n){function o(){this.overlappingShapesLastState=new d,this.overlappingShapesCurrentState=new d,this.recordPool=new i({size:16}),this.tmpDict=new d,this.tmpArray1=[];
}var d=e("./TupleDictionary"),i=e("./OverlapKeeperRecordPool");f.exports=o,o.prototype.tick=function(){for(var e=this.overlappingShapesLastState,f=this.overlappingShapesCurrentState,n=e.keys.length;n--;){var o=e.keys[n],d=e.getByKey(o);d&&this.recordPool.release(d)}e.reset(),e.copy(f),f.reset()},o.prototype.setOverlapping=function(e,f,n,o){var d=this.overlappingShapesCurrentState;if(!d.get(f.id,o.id)){var i=this.recordPool.get();i.set(e,f,n,o),d.set(f.id,o.id,i)}},o.prototype.getNewOverlaps=function(e){return this.getDiff(this.overlappingShapesLastState,this.overlappingShapesCurrentState,e)},o.prototype.getEndOverlaps=function(e){return this.getDiff(this.overlappingShapesCurrentState,this.overlappingShapesLastState,e)},o.prototype.bodiesAreOverlapping=function(e,f){for(var n=this.overlappingShapesCurrentState,o=n.keys.length;o--;){var d=n.keys[o],i=n.data[d];if(i.bodyA===e&&i.bodyB===f||i.bodyA===f&&i.bodyB===e)return!0}return!1},o.prototype.getDiff=function(e,f,n){var n=n||[],o=e,d=f;n.length=0;for(var i=d.keys.length;i--;){var t=d.keys[i],l=d.data[t];if(!l)throw new Error("Key "+t+" had no data!");var p=o.data[t];p||n.push(l)}return n},o.prototype.isNewOverlap=function(e,f){var n=0|e.id,o=0|f.id,d=this.overlappingShapesLastState,i=this.overlappingShapesCurrentState;return!d.get(n,o)&&!!i.get(n,o)},o.prototype.getNewBodyOverlaps=function(e){this.tmpArray1.length=0;var f=this.getNewOverlaps(this.tmpArray1);return this.getBodyDiff(f,e)},o.prototype.getEndBodyOverlaps=function(e){this.tmpArray1.length=0;var f=this.getEndOverlaps(this.tmpArray1);return this.getBodyDiff(f,e)},o.prototype.getBodyDiff=function(e,f){f=f||[];for(var n=this.tmpDict,o=e.length;o--;){var d=e[o];n.set(0|d.bodyA.id,0|d.bodyB.id,d)}for(o=n.keys.length;o--;){var d=n.getByKey(n.keys[o]);d&&f.push(d.bodyA,d.bodyB)}return n.reset(),f}},{"./OverlapKeeperRecordPool":53,"./TupleDictionary":55}],52:[function(e,f,n){function o(e,f,n,o){this.shapeA=f,this.shapeB=o,this.bodyA=e,this.bodyB=n}f.exports=o,o.prototype.set=function(e,f,n,d){o.call(this,e,f,n,d)}},{}],53:[function(e,f,n){function o(){i.apply(this,arguments)}var d=e("./OverlapKeeperRecord"),i=e("./Pool");f.exports=o,o.prototype=new i,o.prototype.constructor=o,o.prototype.create=function(){return new d},o.prototype.destroy=function(e){return e.bodyA=e.bodyB=e.shapeA=e.shapeB=null,this}},{"./OverlapKeeperRecord":52,"./Pool":54}],54:[function(e,f,n){function o(e){e=e||{},this.objects=[],void 0!==e.size&&this.resize(e.size)}f.exports=o,o.prototype.resize=function(e){for(var f=this.objects;f.length>e;)f.pop();for(;f.length<e;)f.push(this.create());return this},o.prototype.get=function(){var e=this.objects;return e.length?e.pop():this.create()},o.prototype.release=function(e){return this.destroy(e),this.objects.push(e),this}},{}],55:[function(e,f,n){function o(){this.data={},this.keys=[]}var d=e("./Utils");f.exports=o,o.prototype.getKey=function(e,f){return e=0|e,f=0|f,(0|e)===(0|f)?-1:0|((0|e)>(0|f)?e<<16|65535&f:f<<16|65535&e)},o.prototype.getByKey=function(e){return e=0|e,this.data[e]},o.prototype.get=function(e,f){return this.data[this.getKey(e,f)]},o.prototype.set=function(e,f,n){if(!n)throw new Error("No data!");var o=this.getKey(e,f);return this.data[o]||this.keys.push(o),this.data[o]=n,o},o.prototype.reset=function(){for(var e=this.data,f=this.keys,n=f.length;n--;)delete e[f[n]];f.length=0},o.prototype.copy=function(e){this.reset(),d.appendArray(this.keys,e.keys);for(var f=e.keys.length;f--;){var n=e.keys[f];this.data[n]=e.data[n]}}},{"./Utils":56}],56:[function(e,f,n){function o(){}f.exports=o,o.appendArray=function(e,f){if(f.length<15e4)e.push.apply(e,f);else for(var n=0,o=f.length;n!==o;++n)e.push(f[n])},o.splice=function(e,f,n){n=n||1;for(var o=f,d=e.length-n;d>o;o++)e[o]=e[o+n];e.length=d},o.arrayRemove=function(e,f){var n=e.indexOf(f);-1!==n&&o.splice(e,n,1)},"undefined"!=typeof P2_ARRAY_TYPE?o.ARRAY_TYPE=P2_ARRAY_TYPE:"undefined"!=typeof Float32Array?o.ARRAY_TYPE=Float32Array:o.ARRAY_TYPE=Array,o.extend=function(e,f){for(var n in f)e[n]=f[n]},o.shallowClone=function(e){var f={};return o.extend(f,e),f},o.defaults=function(e,f){e=e||{};for(var n in f)n in e||(e[n]=f[n]);return e}},{}],57:[function(e,f,n){function o(){this.equations=[],this.bodies=[]}var d=e("../objects/Body");f.exports=o,o.prototype.reset=function(){this.equations.length=this.bodies.length=0};var i=[];o.prototype.getBodies=function(e){var f=e||[],n=this.equations;i.length=0;for(var o=0;o!==n.length;o++){var d=n[o];-1===i.indexOf(d.bodyA.id)&&(f.push(d.bodyA),i.push(d.bodyA.id)),-1===i.indexOf(d.bodyB.id)&&(f.push(d.bodyB),i.push(d.bodyB.id))}return f},o.prototype.wantsToSleep=function(){for(var e=0;e<this.bodies.length;e++){var f=this.bodies[e];if(f.type===d.DYNAMIC&&!f.wantsToSleep)return!1}return!0},o.prototype.sleep=function(){for(var e=0;e<this.bodies.length;e++){var f=this.bodies[e];f.sleep()}return!0}},{"../objects/Body":30}],58:[function(e,f,n){function o(){this.nodePool=new d({size:16}),this.islandPool=new i({size:8}),this.equations=[],this.islands=[],this.nodes=[],this.queue=[]}var d=e("./../utils/IslandNodePool"),i=e("./../utils/IslandPool"),t=e("../objects/Body");f.exports=o,o.getUnvisitedNode=function(e){for(var f=e.length,n=0;n!==f;n++){var o=e[n];if(!o.visited&&o.body.type===t.DYNAMIC)return o}return!1},o.prototype.visit=function(e,f,n){f.push(e.body);for(var o=e.equations.length,d=0;d!==o;d++){var i=e.equations[d];-1===n.indexOf(i)&&n.push(i)}},o.prototype.bfs=function(e,f,n){var d=this.queue;for(d.length=0,d.push(e),e.visited=!0,this.visit(e,f,n);d.length;)for(var i,l=d.pop();i=o.getUnvisitedNode(l.neighbors);)i.visited=!0,this.visit(i,f,n),i.body.type===t.DYNAMIC&&d.push(i)},o.prototype.split=function(e){for(var f=e.bodies,n=this.nodes,d=this.equations;n.length;)this.nodePool.release(n.pop());for(var i=0;i!==f.length;i++){var t=this.nodePool.get();t.body=f[i],n.push(t)}for(var l=0;l!==d.length;l++){var p=d[l],i=f.indexOf(p.bodyA),u=f.indexOf(p.bodyB),s=n[i],c=n[u];s.neighbors.push(c),c.neighbors.push(s),s.equations.push(p),c.equations.push(p)}for(var y=this.islands,i=0;i<y.length;i++)this.islandPool.release(y[i]);y.length=0;for(var a;a=o.getUnvisitedNode(n);){var r=this.islandPool.get();this.bfs(a,r.bodies,r.equations),y.push(r)}return y}},{"../objects/Body":30,"./../utils/IslandNodePool":49,"./../utils/IslandPool":50}],59:[function(e,f,n){function o(e){this.body=e,this.neighbors=[],this.equations=[],this.visited=!1}f.exports=o,o.prototype.reset=function(){this.equations.length=0,this.neighbors.length=0,this.visited=!1,this.body=null}},{}],60:[function(e,f,n){function o(e){a.apply(this),e=e||{},this.springs=[],this.bodies=[],this.disabledBodyCollisionPairs=[],this.solver=e.solver||new t,this.narrowphase=new x(this),this.islandManager=new k,this.gravity=l.fromValues(0,-9.78),e.gravity&&l.copy(this.gravity,e.gravity),this.frictionGravity=l.length(this.gravity)||10,this.useWorldGravityAsFrictionGravity=!0,this.useFrictionGravityOnZeroGravity=!0,this.broadphase=e.broadphase||new m,this.broadphase.setWorld(this),this.constraints=[],this.defaultMaterial=new w,this.defaultContactMaterial=new b(this.defaultMaterial,this.defaultMaterial),this.lastTimeStep=1/60,this.applySpringForces=!0,this.applyDamping=!0,this.applyGravity=!0,this.solveConstraints=!0,this.contactMaterials=[],this.time=0,this.accumulator=0,this.stepping=!1,this.islandSplit=void 0!==e.islandSplit?!!e.islandSplit:!1,this.emitImpactEvent=!0,this.sleepMode=o.NO_SLEEPING,this._constraintIdCounter=0,this._bodyIdCounter=0,this.overlappingShapesLastState={keys:[]},this.overlappingShapesCurrentState={keys:[]},this.overlapKeeper=new h}function d(e,f,n,o,d,i,t,p,u,s,c,y){if(0!==(o.collisionGroup&p.collisionMask)&&0!==(p.collisionGroup&o.collisionMask)&&(l.toGlobalFrame(I,d,n.position,n.angle),l.toGlobalFrame(J,u,t.position,t.angle),!(l.distance(I,J)>o.boundingRadius+p.boundingRadius))){var a=i+n.angle,w=s+t.angle;f.enableFriction=c.friction>0;var b;b=n.type===r.STATIC||n.type===r.KINEMATIC?t.mass:t.type===r.STATIC||t.type===r.KINEMATIC?n.mass:n.mass*t.mass/(n.mass+t.mass),f.slipForce=c.friction*y*b,f.currentContactMaterial=c,f.enabledEquations=n.collisionResponse&&t.collisionResponse&&o.collisionResponse&&p.collisionResponse;var g=f[o.type|p.type],m=0;if(g){var x=o.sensor||p.sensor,j=f.frictionEquations.length;m=o.type<p.type?g.call(f,n,o,I,a,t,p,J,w,x):g.call(f,t,p,J,w,n,o,I,a,x);var v=f.frictionEquations.length-j;if(m){if(n.allowSleep&&n.type===r.DYNAMIC&&n.sleepState===r.SLEEPING&&t.sleepState===r.AWAKE&&t.type!==r.STATIC){var h=l.squaredLength(t.velocity)+Math.pow(t.angularVelocity,2),k=Math.pow(t.sleepSpeedLimit,2);h>=2*k&&(n._wakeUpAfterNarrowphase=!0)}if(t.allowSleep&&t.type===r.DYNAMIC&&t.sleepState===r.SLEEPING&&n.sleepState===r.AWAKE&&n.type!==r.STATIC){var q=l.squaredLength(n.velocity)+Math.pow(n.angularVelocity,2),z=Math.pow(n.sleepSpeedLimit,2);q>=2*z&&(t._wakeUpAfterNarrowphase=!0)}if(e.overlapKeeper.setOverlapping(n,o,t,p),e.has("beginContact")&&e.overlapKeeper.isNewOverlap(o,p)){var A=E;if(A.shapeA=o,A.shapeB=p,A.bodyA=n,A.bodyB=t,A.contactEquations.length=0,"number"==typeof m)for(var B=f.contactEquations.length-m;B<f.contactEquations.length;B++)A.contactEquations.push(f.contactEquations[B]);e.emit(A)}if("number"==typeof m&&v>1)for(var B=f.frictionEquations.length-v;B<f.frictionEquations.length;B++){var C=f.frictionEquations[B];C.setSlipForce(C.getSlipForce()/v)}}}}}function i(e,f){for(var n=e.constraints,o=0;o!==n.length;o++)for(var d=n[o],i=d.equations,t=0;t!==i.length;t++){var l=i[t];l.relaxation=void 0!==f.relaxation?f.relaxation:l.relaxation,l.stiffness=void 0!==f.stiffness?f.stiffness:l.stiffness,l.needsUpdate=!0}}var t=e("../solver/GSSolver"),l=e("../math/vec2"),p=e("../shapes/Circle"),u=e("../shapes/Convex"),s=e("../shapes/Plane"),c=e("../shapes/Capsule"),y=e("../shapes/Particle"),a=e("../events/EventEmitter"),r=e("../objects/Body"),w=e("../material/Material"),b=e("../material/ContactMaterial"),g=e("../collision/AABB"),m=e("../collision/SAPBroadphase"),x=e("../collision/Narrowphase"),j=e("../utils/Utils"),v=j.arrayRemove,h=e("../utils/OverlapKeeper"),k=e("./IslandManager");f.exports=o,o.prototype=new Object(a.prototype),o.prototype.constructor=o;var q={type:"postStep"},z={type:"addBody",body:null},A={type:"removeBody",body:null},B={type:"addSpring",spring:null},C={type:"impact",bodyA:null,bodyB:null,shapeA:null,shapeB:null,contactEquation:null},D={type:"postBroadphase",pairs:null},E={type:"beginContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null,contactEquations:[]},F={type:"endContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null},G={type:"preSolve",contactEquations:null,frictionEquations:null};o.NO_SLEEPING=1,o.BODY_SLEEPING=2,o.ISLAND_SLEEPING=4,o.prototype.addConstraint=function(e){if(this.stepping)throw new Error("Constraints cannot be added during step.");var f=this.bodies;if(-1===f.indexOf(e.bodyA))throw new Error("Cannot add Constraint: bodyA is not added to the World.");if(-1===f.indexOf(e.bodyB))throw new Error("Cannot add Constraint: bodyB is not added to the World.");this.constraints.push(e)},o.prototype.addContactMaterial=function(e){this.contactMaterials.push(e)},o.prototype.removeContactMaterial=function(e){v(this.contactMaterials,e)},o.prototype.getContactMaterial=function(e,f){for(var n=this.contactMaterials,o=0,d=n.length;o!==d;o++){var i=n[o];if(i.materialA===e&&i.materialB===f||i.materialA===f&&i.materialB===e)return i}return!1},o.prototype.removeConstraint=function(e){if(this.stepping)throw new Error("Constraints cannot be removed during step.");v(this.constraints,e)};var H=l.create(),I=l.create(),J=l.create();o.prototype.step=function(e,f,n){if(n=n||10,f=f||0,0===f)this.internalStep(e),this.time+=e;else{this.accumulator+=f;for(var o=0;this.accumulator>=e&&n>o;)this.internalStep(e),this.time+=e,this.accumulator-=e,o++;for(var d=this.accumulator%e/e,i=0;i!==this.bodies.length;i++){var t=this.bodies[i];l.lerp(t.interpolatedPosition,t.previousPosition,t.position,d),t.interpolatedAngle=t.previousAngle+d*(t.angle-t.previousAngle)}}};var K=[];o.prototype.internalStep=function(e){this.stepping=!0;var f=this.springs.length,n=this.springs,i=this.bodies,t=this.gravity,p=this.solver,u=this.bodies.length,s=this.broadphase,c=this.narrowphase,y=this.constraints,a=H,w=l.add,b=this.islandManager;if(this.overlapKeeper.tick(),this.lastTimeStep=e,this.useWorldGravityAsFrictionGravity){var g=l.length(this.gravity);0===g&&this.useFrictionGravityOnZeroGravity||(this.frictionGravity=g)}if(this.applyGravity)for(var m=0;m!==u;m++){var x=i[m],v=x.force;x.type===r.DYNAMIC&&x.sleepState!==r.SLEEPING&&(l.scale(a,t,x.mass*x.gravityScale),w(v,v,a))}if(this.applySpringForces)for(var m=0;m!==f;m++){var h=n[m];h.applyForce()}if(this.applyDamping)for(var m=0;m!==u;m++){var x=i[m];x.type===r.DYNAMIC&&x.applyDamping(e)}for(var k=s.getCollisionPairs(this),z=this.disabledBodyCollisionPairs,m=z.length-2;m>=0;m-=2)for(var A=k.length-2;A>=0;A-=2)(z[m]===k[A]&&z[m+1]===k[A+1]||z[m+1]===k[A]&&z[m]===k[A+1])&&k.splice(A,2);var B=y.length;for(m=0;m!==B;m++){var E=y[m];if(!E.collideConnected)for(var A=k.length-2;A>=0;A-=2)(E.bodyA===k[A]&&E.bodyB===k[A+1]||E.bodyB===k[A]&&E.bodyA===k[A+1])&&k.splice(A,2)}D.pairs=k,this.emit(D),D.pairs=null,c.reset(this);for(var I=this.defaultContactMaterial,J=this.frictionGravity,m=0,L=k.length;m!==L;m+=2)for(var M=k[m],N=k[m+1],O=0,P=M.shapes.length;O!==P;O++)for(var Q=M.shapes[O],R=Q.position,S=Q.angle,T=0,U=N.shapes.length;T!==U;T++){var V,W=N.shapes[T],X=W.position,Y=W.angle;Q.material&&W.material&&(V=this.getContactMaterial(Q.material,W.material)),d(this,c,M,Q,R,S,N,W,X,Y,V||I,J)}for(var m=0;m!==u;m++){var Z=i[m];Z._wakeUpAfterNarrowphase&&(Z.wakeUp(),Z._wakeUpAfterNarrowphase=!1)}if(this.has("endContact")){this.overlapKeeper.getEndOverlaps(K);for(var $=F,T=K.length;T--;){var _=K[T];$.shapeA=_.shapeA,$.shapeB=_.shapeB,$.bodyA=_.bodyA,$.bodyB=_.bodyB,this.emit($)}K.length=0}G.contactEquations=c.contactEquations,G.frictionEquations=c.frictionEquations,this.emit(G),G.contactEquations=G.frictionEquations=null;var B=y.length;for(m=0;m!==B;m++)y[m].update();if(c.contactEquations.length||c.frictionEquations.length||B)if(this.islandSplit){for(b.equations.length=0,j.appendArray(b.equations,c.contactEquations),j.appendArray(b.equations,c.frictionEquations),m=0;m!==B;m++)j.appendArray(b.equations,y[m].equations);b.split(this);for(var m=0;m!==b.islands.length;m++){var ee=b.islands[m];ee.equations.length&&p.solveIsland(e,ee)}}else{for(p.addEquations(c.contactEquations),p.addEquations(c.frictionEquations),m=0;m!==B;m++)p.addEquations(y[m].equations);this.solveConstraints&&p.solve(e,this),p.removeAllEquations()}for(var m=0;m!==u;m++){var Z=i[m];Z.integrate(e)}for(var m=0;m!==u;m++)i[m].setZeroForce();if(this.emitImpactEvent&&this.has("impact"))for(var fe=C,m=0;m!==c.contactEquations.length;m++){var ne=c.contactEquations[m];ne.firstImpact&&(fe.bodyA=ne.bodyA,fe.bodyB=ne.bodyB,fe.shapeA=ne.shapeA,fe.shapeB=ne.shapeB,fe.contactEquation=ne,this.emit(fe))}if(this.sleepMode===o.BODY_SLEEPING)for(m=0;m!==u;m++)i[m].sleepTick(this.time,!1,e);else if(this.sleepMode===o.ISLAND_SLEEPING&&this.islandSplit){for(m=0;m!==u;m++)i[m].sleepTick(this.time,!0,e);for(var m=0;m<this.islandManager.islands.length;m++){var ee=this.islandManager.islands[m];ee.wantsToSleep()&&ee.sleep()}}this.stepping=!1,this.emit(q)},o.prototype.addSpring=function(e){if(this.stepping)throw new Error("Springs cannot be added during step.");this.springs.push(e),B.spring=e,this.emit(B),B.spring=null},o.prototype.removeSpring=function(e){if(this.stepping)throw new Error("Springs cannot be removed during step.");v(this.springs,e)},o.prototype.addBody=function(e){if(this.stepping)throw new Error("Bodies cannot be added during step.");if(e.world)throw new Error("Body is already added to a World.");this.bodies.push(e),e.world=this,z.body=e,this.emit(z),z.body=null},o.prototype.removeBody=function(e){if(this.stepping)throw new Error("Bodies cannot be removed during step.");for(var f=this.constraints,n=f.length;n--;)if(f[n].bodyA===this||f[n].bodyB===this)throw new Error("Cannot remove Body from World: it still has constraints connected to it.");e.world=null,v(this.bodies,e),A.body=e,e.resetConstraintVelocity(),this.emit(A),A.body=null;for(var o=this.disabledBodyCollisionPairs,d=0;d<o.length;)o[d]===e||o[d+1]===e?o.splice(d,2):d+=2},o.prototype.getBodyById=function(e){for(var f=this.bodies,n=0;n<f.length;n++){var o=f[n];if(o.id===e)return o}return!1},o.prototype.disableBodyCollision=function(e,f){this.disabledBodyCollisionPairs.push(e,f)},o.prototype.enableBodyCollision=function(e,f){for(var n=this.disabledBodyCollisionPairs,o=0;o<n.length;o+=2)if(n[o]===e&&n[o+1]===f||n[o+1]===e&&n[o]===f)return void n.splice(o,2)},o.prototype.clear=function(){this.solver.removeAllEquations();for(var e=this.constraints,f=e.length;f--;)this.removeConstraint(e[f]);var n=this.bodies;for(f=n.length;f--;)this.removeBody(n[f]);var o=this.springs;for(f=o.length;f--;)this.removeSpring(o[f]);var d=this.contactMaterials;for(f=d.length;f--;)this.removeContactMaterial(d[f])};var L=l.create(),M=l.create();o.prototype.hitTest=function(e,f,n){n=n||0;var o=new r({position:e}),d=new y,i=e,t=0,a=L,w=M;o.addShape(d);for(var b=this.narrowphase,g=[],m=0,x=f.length;m!==x;m++)for(var j=f[m],v=0,h=j.shapes.length;v!==h;v++){var k=j.shapes[v];l.rotate(a,k.position,j.angle),l.add(a,a,j.position);var q=k.angle+j.angle;(k instanceof p&&b.circleParticle(j,k,a,q,o,d,i,t,!0)||k instanceof u&&b.particleConvex(o,d,i,t,j,k,a,q,!0)||k instanceof s&&b.particlePlane(o,d,i,t,j,k,a,q,!0)||k instanceof c&&b.particleCapsule(o,d,i,t,j,k,a,q,!0)||k instanceof y&&l.squaredLength(l.sub(w,a,e))<n*n)&&g.push(j)}return g},o.prototype.setGlobalStiffness=function(e){i(this,{stiffness:e});for(var f=this.contactMaterials,n=0;n!==f.length;n++){var o=f[n];o.stiffness=o.frictionStiffness=e}var o=this.defaultContactMaterial;o.stiffness=o.frictionStiffness=e},o.prototype.setGlobalRelaxation=function(e){i(this,{relaxation:e});for(var f=0;f!==this.contactMaterials.length;f++){var n=this.contactMaterials[f];n.relaxation=n.frictionRelaxation=e}var n=this.defaultContactMaterial;n.relaxation=n.frictionRelaxation=e};var N=new g,O=[];o.prototype.raycast=function(e,f){return f.getAABB(N),this.broadphase.aabbQuery(this,N,O),f.intersectBodies(e,O),O.length=0,e.hasHit()}},{"../collision/AABB":6,"../collision/Narrowphase":9,"../collision/SAPBroadphase":12,"../events/EventEmitter":25,"../material/ContactMaterial":26,"../material/Material":27,"../math/vec2":29,"../objects/Body":30,"../shapes/Capsule":37,"../shapes/Circle":38,"../shapes/Convex":39,"../shapes/Particle":42,"../shapes/Plane":43,"../solver/GSSolver":45,"../utils/OverlapKeeper":51,"../utils/Utils":56,"./IslandManager":58}]},{},[35])(35)});